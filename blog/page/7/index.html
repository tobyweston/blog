
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bad.robot</title>
  <meta name="author" content="Toby Weston">

  
  <meta name="description" content="When interviewing, I often like to ask a candidate to discuss inheritance vs composition using a Stack as an example. Example 1. public class &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://baddotrobot.com/blog/page/7/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="bad.robot" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Averia+Libre:300' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

<!-- Load jQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
    jQuery.noConflict(); // ender.js conflicts with jQuery
</script>

<!-- Load FancyBox -->
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" />
<script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

<!-- Fix FancyBox style for OctoPress -->
<style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style>


<!-- Custom Scripts -->
<script language="Javascript" type="text/javascript">
    // ender.js gobbles jQuery's ready event: Use ender.js $ instead
    $(document).ready(function() {
        jQuery(".fancybox").fancybox({

            openEffect	: 'none',
            closeEffect	: 'none',

            helpers : {
                title: {
                    type: 'float'
                }
            }
        });
    });
</script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3327317-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
    <!-- last update; 2013-05-24 12:43:18 +0100 -->
    <h1><a href="/"><font color="#C7DEBC">bad</font><font color="#C8CDCB">.robot</font></a></h1>
    
    <h2>good robots do what they're told</h2>
    
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:baddotrobot.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/code">Code</a></li>
  <li><a href="/book">Book</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2009/01/24/inheritance-vs-composition/">Inheritance vs Composition</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2009-01-24T00:00:00+00:00" pubdate data-updated="true">Jan 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When interviewing, I often like to ask a candidate to discuss inheritance vs composition using a <code>Stack</code> as an example.</p>

<h3>Example 1.</h3>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EvilStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">T</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Example 2.</h3>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">T</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Extending <code>Vector</code> as in example 1 weakens the encapsulation of the class. Suddenly, methods to get and insert elements at specific positions are available to clients of the stack. We move from trying to create a well behaved LIFO stack to creating a socially irresponsible monster: an <code>EvilStack</code>.</p>

<p>So I was surprised when looking at the Java source to see that <code>java.util.Stack</code> actually extends <code>Vector</code>! Naughty and things <a href="/blog/2013/01/10/stack-vs-deque">aren&#8217;t any better in Java 7 and 8</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2009/01/22/deprecated-annotation/">Deprecated Annotation</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2009-01-22T00:00:00+00:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Why didn&#8217;t Sun add a <code>value</code> property to the <code>@Deprecated</code> annotation? Instead of</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Documented</span>
</span><span class='line'><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Deprecated</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which kind of implies we should do the following.</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Deprecated</span>
</span><span class='line'><span class="cm">/** @deprecated use {@link Foo} instead */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoneOff</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>why can&#8217;t we have</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Documented</span>
</span><span class='line'><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">MyDeprecated</span><span class="o">{</span>
</span><span class='line'>   <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which means we can use</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MyDeprecated</span><span class="o">(</span><span class="s">&quot;use Foo instead&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoneOff</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// ...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2009/01/06/be-more-expressive-with-builders/">Be more Expressive with Builders</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2009-01-06T00:00:00+00:00" pubdate data-updated="true">Jan 6<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I came up with a neat little pattern that&#8217;s helped me be more expressive in some (fairly specific) situations. Here I&#8217;ll give you a feel for it using the <code>CountDownLatch</code> class as an example.</p>

<h2>CountDownLatch.await()</h2>

<p>Using an instance of a <code>CountDownLatch</code>, we can wait for the latch to count down to zero, blocking the calling thread before continuing. When using a timeout, the method returns true if the count reached zero or false if the timeout expires. To make the timeout more explicit in my application code, I started with the following.</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">waitForStartup</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">startup</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">SECONDS</span><span class="o">))</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">TimeoutException</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">waitForShutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">shutdown</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">SECONDS</span><span class="o">))</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">TimeoutException</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using a Builder with Static Constructor</h2>

<p>To be more concise, I wanted to wrap the logic above in some kind of helper class. Thanks to lovely static imports, a private constructor and a static factory method called <code>await()</code>, I was able to express the same thing with the following.</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">waitForStartup</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">await</span><span class="o">(</span><span class="n">startup</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">TIMEOUT</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">waitForShutdown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">await</span><span class="o">(</span><span class="n">shutdown</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">TIMEOUT</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>with(...)</code> method is the thing that actually wraps the call to the <code>await()</code> method on the latch. I created a <code>Duration</code> class in the above case to capture the timeout constant.</p>

<p>This can be a neat little pattern which when used sparingly can lead to little nuggets of really readable code. However, the helper class that employs the static factory can feel unnatural as the method names don&#8217;t really represent their function but <strong>rather their context within the DSL that the class defines</strong>.</p>

<p>Using a private constructor and verifying the internal state is essential to ensure that the DSL can&#8217;t be used incorrectly. Basically, if there are very few methods and you make sure they can only be called in a sensible order, I&#8217;d suggest its a good pattern to follow. The finished class is shown below in full.</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchWithTimeout</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">latch</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">CountDownLatchWithTimeout</span><span class="o">(</span><span class="n">CountDownLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CountDownLatchWithTimeout</span> <span class="nf">await</span><span class="o">(</span><span class="n">CountDownLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">CountDownLatchWithTimeout</span><span class="o">(</span><span class="n">latch</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">with</span><span class="o">(</span><span class="n">Duration</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="n">timeout</span><span class="o">.</span><span class="na">inMillis</span><span class="o">(),</span> <span class="n">MILLISECONDS</span><span class="o">))</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">TimeoutException</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/31/what-makes-good-pair/">What Makes a Good Pair?</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-31T00:00:00+00:00" pubdate data-updated="true">Dec 31<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="../../../../../images/cookies_milk.png"><img class="right" src="../../../../../images/cookies_milk.png"></a></p>

<p>Communication plays such a big part in what we do, we&#8217;re always striving to be more expressive in our code, conveying our intent as clearly as possible. It&#8217;s the same when pairing. We need to be expressive, communicate our intent, engage, listen and feedback. When we don&#8217;t do these things, pairing just doesn&#8217;t work. When we don&#8217;t collaborate, we&#8217;re not getting as much out of pairing as we could be. Perhaps it&#8217;s only after working in a good pair that you realise what you&#8217;re missing working in a bad pairing.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/30/be-explicit-about-ui-thread-in-swt/">Be Explicit with the UI Thread</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-30T00:00:00+00:00" pubdate data-updated="true">Dec 30<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following up from the post <a href="/blog/2008/12/29/swt-support-for-window-licker/">SWT Support in Window Licker</a>.</p>

<p>The thing I found most interesting about looking at this was having to be more explicit about the UI thread. When developing SWT applications, we&#8217;re all aware that accessing almost anything graphical in SWT from any other thread than the UI thread spells &#8220;invalid thread access&#8221;, but it was fun to be more explicit about the &#8220;UI thread&#8221;.</p>

<p>When I started to look at how I go about writing SWT applications, I noticed that</p>

<ul>
<li>I often run the application from a <code>main</code> method somewhere which runs on the <code>main</code> thread.</li>
<li>I often discover invalid thread access problems at run time.</li>
<li>I often plug the problem by wrapping the offender in a <code>Display.sync(...)</code> or <code>Display.async(...)</code> call.</li>
<li>I often have very few long running processes that need to spawn a thread and update the UI.</li>
</ul>


<p>It wasn&#8217;t until I started looking at being able to run the application from the context of a JUnit test that I started to think in more detail about these.</p>

<h2>Running the application from a main method</h2>

<p>This seems simple but being more explicit about the UI thread means that this is worth a closer look. I always used to start an SWT application from the <code>main</code> method, in variations of the code below.</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SwtCalculator</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">SwtCalculator</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">SwtCalculator</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="o">.</span><span class="na">detDefault</span><span class="o">();</span>
</span><span class='line'>        <span class="n">shell</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Shell</span><span class="o">(</span><span class="n">display</span><span class="o">);</span>
</span><span class='line'>        <span class="n">shell</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;Calculator&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// shell setup</span>
</span><span class='line'>        <span class="n">startEventLoop</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startEVentLoop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(!</span><span class="n">shell</span><span class="o">.</span><span class="na">isDisposed</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(!</span><span class="n">display</span><span class="o">.</span><span class="na">readAndDispatch</span><span class="o">())</span>
</span><span class='line'>                <span class="n">display</span><span class="o">.</span><span class="na">sleep</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">display</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The default constructor would do or delegate the work to setup the various shells and widgets and finally start the event loop. When using JFace&#8217;s <code>ApplicationWindow</code>, I&#8217;d do pretty much the same thing. Calling <code>window.setBlockOnOpen(true)</code> just shifts the responsibility of starting the event loop to the <code>ApplicationWindow class</code>. If you call <code>window.setBlockOnOpen(false)</code> for example, you have to manually start an event loop.</p>

<p>However you do it, getting into that event loop blocks the client and <strong>it&#8217;s the thread that executes this event loop that is called the UI thread</strong>. It just so happens that most SWT applications will hit that loop from the main thread as you can see from the following partial thread dump.</p>

<pre><code>Name: main
State: RUNNABLE
Total blocked: 0 Total waited: 0

Stack trace:
    org.eclipse.swt.internal.win32.OS.WaitMessage(Native Method)
    org.eclipse.swt.widgets.Display.sleep(Unknown Source)
    com.objogate...SwtCalculator.startEventLoop(SwtCalculator.java:104)
    com.objogate...SwtCalculator.main(SwtCalculator.java:113)
</code></pre>

<p>At this point, the SWT event loop is doing its thing, waiting for UI events (mouse clicks, keyboard input etc) and dispatching them to the appropriate listeners. So, we can define what we mean by the UI thread;</p>

<blockquote><p>The UI thread or event dispatching thread is the thread that executes the standard SWT event loop.</p></blockquote>

<h2>Running the tests and GUI in different threads</h2>

<p>So, if the event loop was called from within say a <code>@Before</code> annotated method in a test, the test would block until the event loop finished, the display would be disposed and any subsequent tests against the GUI elements would quickly discover that they no longer exist.</p>

<p>It should be pretty clear then that in order to test GUI elements the event loop has to be started in a different thread than the tests run in. The gotcha is that the test thread will likely want to interact with this UI thread in order to push buttons and make assertions and that&#8217;s when we get into invalid thread access territory with SWT.</p>

<p>The way I implemented this was to use a class extending <code>Thread</code> to represent the UI thread and to start the event loop in its <code>run()</code> method. The tests can interact with the UI thread by either searching for the display with <code>Display.findDisplay(thread)</code> or by cooperating and ensuring that only the default display is used (retrieving it using <code>Display.getDefault()</code>).</p>

<p>A minor change to the application&#8217;s main method is required to optionally not call the event loop when calling main. For example;</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SwtCalculator</span> <span class="n">calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SwtCalculator</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">shouldBlock</span><span class="o">(</span><span class="n">args</span><span class="o">))</span>
</span><span class='line'>        <span class="n">calculator</span><span class="o">.</span><span class="na">startEventLoop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The tests can then explicitly create a UI thread delegating shell setup to the <code>SwtCalculator</code> class before starting the event loop and allowing the test thread to continue.</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Before</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">runTheApplication</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">thread</span> <span class="o">=</span> <span class="n">UIThread</span><span class="o">.</span><span class="na">startNewUIThread</span><span class="o">(</span><span class="k">new</span> <span class="n">UISetupClosure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">performAdditionalSetup</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">SwtCalculator</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">DONT_BLOCK_ON_OPEN</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'>    <span class="n">ui</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SwtCalculatorDriver</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">calculatorCanAddTwoNumbers</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// testing the calculator whilst the main thread is running and</span>
</span><span class='line'>    <span class="c1">// the UI has been started in another thread (from @Before)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@After</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">stopTheApplication</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>UISetupClosure</code> allows the setup code (in this case the main method) to run inside the UI thread. This uses the strategy pattern but an alternative design could just as easily sub-class the <code>UIThread</code> and use the template pattern in a similar way.</p>

<p>The interrupt allows the event loop on the UI thread to be interrupted and stop gracefully.</p>

<p>The following partial thread dump shows it in action. As you can see, an explicit thread has started the event loop (the <code>Display.sleep</code> and <code>WaitMessage</code>
are the hints).</p>

<pre><code>Name: SWT-Event-Dispatcher-Thread-1
State: RUNNABLE
Total blocked: 0 Total waited: 0

Stack trace:
    org.eclipse.swt.internal.win32.OS.WaitMessage(Native Method)
    org.eclipse.swt.widgets.Display.sleep(Unknown Source)
    com.objogate.wl.swt.UIThread.startEventLoop(UIThread.java:90)
    com.objogate.wl.swt.UIThread.run(UIThread.java:68)
    - locked java.lang.Class@1d7fbfb
</code></pre>

<p>It was a good exercise exploring the UI thread and I encourage you to take a look at <a href="http://code.google.com/p/windowlicker/">Window Licker</a> (and my <a href="http://windowlicker-users.googlegroups.com/web/window-licker-swt-spike.patch">SWT patch</a>). Have a play and see if you agree with the approach I took above.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/29/swt-support-for-window-licker/">SWT Support for Window Licker</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-29T00:00:00+00:00" pubdate data-updated="true">Dec 29<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://code.google.com/p/windowlicker/">Window Licker</a> is a framework designed to help you define your own API for GUI testing. It provides a driver style API that your Swing or Ajax applications plug into before you go about writing GUI tests in a language natural to your application.</p>

<p>We&#8217;ve been doing some driver based GUI testing for our web apps using <a href="http://htmlunit.sourceforge.net/">HtmlUnit</a> so I was naturally interested in Window Licker with regard to rich client based testing. I&#8217;ve been trying to test my SWT based apps at the unit level as much as possible, but it&#8217;s not always straight forward separating the behaviour of GUI classes from GUI elements. How do you test that all the validation behaviour is plumbed in correctly and fires at the right time in a text box? So, Window Licker seemed like a great candidate to getting some real user style testing. Great!</p>

<p>The bad news is that Window Licker doesn&#8217;t yet support SWT. Boo! The good news is it gave me a great chance to have a go at implementing basic SWT support in Window Licker. Yey!</p>

<p>Check out the <a href="http://windowlicker-users.googlegroups.com/web/window-licker-swt-spike.patch">patch</a> I wrote, or the <a href="http://groups.google.com/group/windowlicker-users/browse_thread/thread/6fb792261a9cd1e7">thread</a> where it&#8217;s discussed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/29/swt-applications-on-mac-os-x/">SWT Applications on Mac OS X</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-29T00:00:00+00:00" pubdate data-updated="true">Dec 29<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve had a couple of problems running SWT applications on Mac, in particular, getting balloon tool tips to appear and incorrect invalid thread access errors. It seems that the Mac specific VM option <code>-XstartOnFirstThread</code> is the cure! It even addresses the bug I reported <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=247218">here</a>!</p>

<p>It seems that by default, Java will not start on the main thread. Cocoa/Carbon starts it all and as a consequence, the SWT UI thread might get associated with it and not your main application thread. Therefore, whenever the application tries to access it (even though it looks like it owns it in your code), it may not and invalid thread access hilarity will ensue.</p>

<p>The flip side to this is that AWT/Swing apps and plugins might have problems.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/24/interfaces-vs-class-imposterisers/">Interfaces vs Class impostorisers</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-24T00:00:00+00:00" pubdate data-updated="true">Dec 24<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been mocking with JMock2 for a while now and fully buy into using mocks and driving out behaviour using interfaces. However, I&#8217;m not sure I get the resistance when people want to use class imposterisers.</p>

<p>I&#8217;ve been doing a lot with SWT lately and generally want to unit test the UI elements. One way I&#8217;ve managed to do this is to mock parts of the GUI framework using impostorisers. Unless I want the full UI brought up, there just isn&#8217;t another way. The UI API doesn&#8217;t offer me any convenient interfaces and I can&#8217;t even create sub-classed mocks myself as SWT prevents you from sub-classing with run time checks.</p>

<p>I understand that by slowly teasing out behaviour during the mocking / TDD process you can clearly express the collaborations a class may have but I feel that you can still be clear about class behaviour when using an impostor. It&#8217;s just code right? I&#8217;m not sure I care that collaborations are documented as interfaces or not, my tests express the relationships and I&#8217;ve gone through the same thought process to understand clearly how the classes under test interact. So why is an impostor the bad guy?</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2008/12/24/interfaces-vs-class-imposterisers/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/17/junit-and-threaded-tests-i-recently/">JUnit and Threaded Tests</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-17T00:00:00+00:00" pubdate data-updated="true">Dec 17<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently noticed a bit of a problem when playing with threads within JUnit. Take the following snippet as an example;</p>

<figure class='code'> <div class="highlight"><table><tr></pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">exaple</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;bye&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">(),</span> <span class="n">is</span><span class="o">(</span><span class="n">NON_DAEMON</span><span class="o">));</span>
</span><span class='line'>    <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the string &#8220;bye&#8221; is never shown, it would seem that when the test method finishes it somehow messes with the threads&#8230;</p>

<p>Looking into things, it seems in my case that naughty Eclipse is muddying the water! The <code>RemoteTestRunner</code> class which Eclipse uses to run the tests ends up calling <code>System.exit(0)</code> after it&#8217;s run all the tests to kill the parent Java process. Even if we changed the daemon status of the thread, you&#8217;d get the same behaviour, ie, no &#8220;bye&#8221; being shown.</p>

<p>So, in some situations it is possible to kill a thread in a JUnit test bypassing the interrupt mechanism when running a test from Eclipse. IntelliJ actually seems to have the same behaviour but I can&#8217;t review to source to confirm.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2008/12/11/bit-disappointing-this-year/">XPDay 2008</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2008-12-11T00:00:00+00:00" pubdate data-updated="true">Dec 11<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Bit disappointing really. Things didn&#8217;t get started properly will around 12:00 on day 1. I got to attend two really interesting talks of ~30 minutes each but then got trapped in a couple of nightmarish &#8216;Open Spaces&#8217; which ended up being a rather self-indulgent discussions about nothing in particular.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/8/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/6/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/24/mac-tips/">Mac Tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/23/useful-git-commands/">Useful Git Commands</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/10/stack-vs-deque/">Java Stack vs Deque</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/sending-messages-vs-method-invocation/">Sending Messages vs Method Invocation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/15/daily-standups-dont-work/">Daily Standups Don&#8217;t Work</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/14/diff-excel-with-java-and-hamcrest/">Diff Excel with Java and Hamcrest</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/28/play-it-next/">Play it Next App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/13/oauth-and-http-part-iii/">FreeAgent, OAuth &amp; HTTP (Part III)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/12/oauth-and-http-part-ii/">FreeAgent, OAuth &amp; HTTP (Part II)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/11/oauth-and-http-part-i/">FreeAgent, OAuth &amp; HTTP (Part I)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/28/mountain-lion-carnage/">Mountain Lion Carnage</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/22/getting-things-done-ii/">Getting Things Done, Part II</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <p align="justify">     
      <a href="/blog/categories/agile/">agile</a>
      <a href="/blog/categories/coaching/">coaching</a>
      <a href="/blog/categories/concurrency/">concurrency</a>
      <a href="/blog/categories/exceptions/">exception-handling</a>
      <a href="/blog/categories/java/">java</a>
      <a href="/blog/categories/mocking/">mocking</a>
      <a href="/blog/categories/object-oriented/">object-oriented</a>
      <a href="/blog/categories/performance/">performance</a>
      <a href="/blog/categories/recipes/">recipes</a>
      <a href="/blog/categories/rest/">REST</a>
      <a href="/blog/categories/scala/">scala</a>
      <a href="/blog/categories/tempus-fugit/">tempus-fugit</a>
      <a href="/blog/categories/testing/">testing</a>
  </p>
</section>
<section>
  <h1>Popular Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/09/14/diff-excel-with-java-and-hamcrest/">Diff Excel with Java and Hamcrest</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/10/18/logging-is-evil-but/">Logging is evil but&#8230;</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/03/04/jdk-7-previewed/">JDK7 Previewed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/10/artcile-in-javatech-journal/">JDK7 Article in JavaTech Journal</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/22/loggin-is-still-evil-but/">Logging is still evil but&#8230;</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Available on Leanpub</h1>
    <br/>
    <iframe width="250" height="400" src="https://leanpub.com/essential_acceptance_testing/embed" frameborder="0" allowtransparency="true"></iframe>
</section>
<section>
    <h1>Publications</h1>
    <br/>
    <a href="/resources/JTJ-2011-05.pdf"><img class="left" src="/images/JTJ-2011-05.png" alt="Read my JDK7 article" width="125" height="150" onclick="_gaq.push(['_trackEvent', 'download', 'jdk7-article', 'pdf']);"></a>
    <p>
        My article on JDK7 in <a href="http://jaxenter.com/java-tech-journal">JavaTech Journal</a> (May 2011)
    </p>
    <br/>
    <br/>
    <br/>
    <br/>

    <br/>
    <a href="/resources/concurrency-control-1.0-draft.pdf"><img class="left" src="/images/concurrency-control-1.0-draft.png" alt="Read my JDK7 article" width="125" height="150" onclick="_gaq.push(['_trackEvent', 'download', 'concurrency-control', 'pdf']);"></a>
    <p>
        My draft paper discussing <a href="/resources/concurrency-control-1.0-draft.pdf">Optimistic and Pessimistic Concurrency Control with Shared Memory Models</a>.
    </p>

    <br/>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jamanifin", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jamanifin" class="twitter-follow-button" data-show-count="false">Follow @jamanifin</a>
  
</section>

<section>
    <h1>Links</h1>
    <ul>
        <li><a href="http://dan.bodar.com/">Dan Bodart</a></li>
        <li><a href="http://www.natpryce.com/">Nat Pryce</a></li>
        <li><a href="http://www.higherorderlogic.com/">Steve Freeman</a></li>
        <li><a href="http://langrsoft.com/">Jeff Langr</a></li>
        <li><a href="http://tech.puredanger.com/">Alex Miller</a></li>
        <li><a href="http://blog.davidpeterson.co.uk/">David Peterson</a></li>
    </ul>
</section>
<section xmlns="http://www.w3.org/1999/html">
    </br>
    </br>
    </br>
    <img src="images/top5.png" style="border: none; -webkit-box-shadow: none; box-shadow: none; transform: rotate(-5deg); -moz-transform: rotate(-5deg); -webkit-transform: rotate(-5deg);"/>
    </br>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2006-2013 - Toby Weston -
   <a href="/excludeme">exclude from analytics</a> -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, theme by <a href="http://melandri.net/"> @alemelandri</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'badrobot';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
