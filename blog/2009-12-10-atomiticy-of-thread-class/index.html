<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.18.0"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1PVLDLDJQN"></script><script>(function(){const gaId = "G-1PVLDLDJQN";

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', gaId);
    })();</script><!-- Canonical URL --><link rel="canonical" href="https://baddotrobot.com/blog/2009-12-10-atomiticy-of-thread-class/"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="bad.robot" href="/rss.xml"><!-- Primary Meta Tags --><title>Atomiticy of the Thread class</title><meta name="title" content="Atomiticy of the Thread class"><meta name="description" content="Java's Thread class does not maintain thread state atomically with its interrupt status flag, leading to subtle race conditions in state checking."><meta name="keywords" content="Java Thread, interrupt status, thread state, RUNNABLE, WAITING, atomicity, concurrency, race condition"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://baddotrobot.com/blog/2009-12-10-atomiticy-of-thread-class/"><meta property="og:title" content="Atomiticy of the Thread class"><meta property="og:description" content="Java's Thread class does not maintain thread state atomically with its interrupt status flag, leading to subtle race conditions in state checking."><meta property="og:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><meta property="og:site_name" content="bad.robot"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://baddotrobot.com/blog/2009-12-10-atomiticy-of-thread-class/"><meta property="twitter:title" content="Atomiticy of the Thread class"><meta property="twitter:description" content="Java's Thread class does not maintain thread state atomically with its interrupt status flag, leading to subtle race conditions in state checking."><meta property="twitter:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Atomiticy of the Thread class","description":"Java's Thread class does not maintain thread state atomically with its interrupt status flag, leading to subtle race conditions in state checking.","datePublished":"2009-12-10T00:00:00.000Z","url":"https://baddotrobot.com/blog/2009-12-10-atomiticy-of-thread-class/","author":{"@type":"Person","name":"Toby Weston","url":"https://baddotrobot.com"},"publisher":{"@type":"Person","name":"bad.robot"}}</script><link rel="stylesheet" href="/_astro/index.BiihJROh.css">
<style>.giscus-wrapper[data-astro-cid-2s6z27su]{margin-top:3rem;padding-top:0}.giscus-divider[data-astro-cid-2s6z27su]{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem}.giscus-divider[data-astro-cid-2s6z27su]:before,.giscus-divider[data-astro-cid-2s6z27su]:after{content:"";flex:1;height:1px;background:var(--border)}.giscus-divider-label[data-astro-cid-2s6z27su]{text-transform:uppercase;letter-spacing:.2em;color:var(--accent);font-size:.75rem;font-weight:600;white-space:nowrap}.giscus[data-astro-cid-2s6z27su],.giscus-frame[data-astro-cid-2s6z27su]{width:100%}
</style>
<link rel="stylesheet" href="/_astro/_slug_.Bryw6KM9.css"></head> <body class="bg-white text-gray-900"> <header class="header" data-astro-cid-3ef6ksr2> <div class="header-container" data-astro-cid-3ef6ksr2> <div class="logo-section" data-astro-cid-3ef6ksr2> <a href="/" class="logo-link" data-astro-cid-3ef6ksr2> <img src="/_astro/robot-logo_105x132.N1ZQY9mA_Zj02tT.webp" alt="bad.robot logo" data-astro-cid-3ef6ksr2="true" loading="lazy" decoding="async" fetchpriority="auto" width="84" height="106" class="logo-image"> <div class="logo-text-block" data-astro-cid-3ef6ksr2> <h1 class="logo-title logo-text header-logo-text" data-astro-cid-3ef6ksr2>bad.robot</h1> <h2 class="logo-subtitle logo-subtitle-text header-subtitle" data-astro-cid-3ef6ksr2>good robots do what they&#39;re told</h2> </div> </a> </div> <nav class="nav" data-astro-cid-3ef6ksr2> <a href="/blog" data-astro-cid-3ef6ksr2>Blog</a> <a href="/book" data-astro-cid-3ef6ksr2>Books</a> <a href="/video" data-astro-cid-3ef6ksr2>Videos</a> <a href="/archive" data-astro-cid-3ef6ksr2>Archive</a> </nav> <div id="header-animation-switcher" class="header-switcher" style="display: none;" data-astro-cid-3ef6ksr2> <div class="switcher-buttons" data-astro-cid-3ef6ksr2> <button class="switcher-btn active" data-option="1" title="Smooth Fade Only" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>‚ö´</span> </button> <button class="switcher-btn" data-option="2" title="Fade + Gentle Lift" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>‚¨ÜÔ∏è</span> </button> <button class="switcher-btn" data-option="3" title="Slide In Left" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>‚û°Ô∏è</span> </button> <button class="switcher-btn" data-option="4" title="Blur Fade" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>üîÆ</span> </button> <button class="switcher-btn" data-option="5" title="Subtle Scale" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>üìà</span> </button> </div> </div> </div> </header>  <main id="site-main" class="mx-auto w-full max-w-6xl px-4 pt-4">   <div class="py-12"> <article class=""> <!--{heroImage && (--> <!--  <div class="hero-image mb-8">--> <!--    <img src={heroImage} alt={title} class="w-full h-auto rounded-lg shadow-lg" />--> <!--  </div>--> <!--)}--> <div class="article-title-section mb-8"> <p class="detail-kicker">Blog</p> <h1 class="article-title-section h1">Atomiticy of the Thread class</h1> <p class="article-subtitle">Why Java threads don&#39;t always maintain state atomically with interrupt flags</p> <p class="article-description">Java&#39;s Thread class does not maintain thread state atomically with its interrupt status flag, leading to subtle race conditions in state checking.</p> </div> <div class="article-meta"> <div class="article-date"> <strong>Published:</strong> <time datetime="2009-12-10T00:00:00.000Z"> Dec 10, 2009 </time> </div>  </div> <div class="prose">  <p>I had an interesting time getting a couple of tests running for <a href="http://tempusfugitlibrary.org/">tempus-fugit</a> recently. It threw up a couple of interesting aspects about using threads that I hadn‚Äôt come across before.</p>
<p>In one particular test, I wanted to show that interrupt is called on a thread and so followed what‚Äôs becoming a common pattern for me.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Test</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> sleepInterrupted</span><span style="color:#E1E4E8">() throws Exception {</span></span>
<span class="line"><span style="color:#E1E4E8">   Thread thread </span><span style="color:#F97583">=</span><span style="color:#B392F0"> threadSleepsForever</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">   thread.</span><span style="color:#B392F0">start</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">   waitForStartup</span><span style="color:#E1E4E8">(thread);</span></span>
<span class="line"><span style="color:#E1E4E8">   thread.</span><span style="color:#B392F0">interrupt</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">   waitForShutdown</span><span style="color:#E1E4E8">(thread);</span></span>
<span class="line"><span style="color:#B392F0">   assertThat</span><span style="color:#E1E4E8">(thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">(), </span><span style="color:#B392F0">is</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">}  ```</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">The alternative patten is to wait </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> the assertion and avoid the wait </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> shutdown method above. Either way, the test above is testing that the thread created has been interrupted by checking the interrupt flag.</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#E1E4E8">The test was failing </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> me even though I was able to show that the interrupt is called and the interrupt flag is set immediately after the sleeping thread is woken. However, when the test reached the assertion, it was </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">. Weird.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">I setup another thread to just poll the sleeping thread </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> its status and it showed the following.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">, thread.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> RUNNABLE  </span></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">, thread.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> RUNNABLE  </span></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">, thread.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> RUNNABLE  </span></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">, thread.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> TIMED_WAITING  </span></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">, thread.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> RUNNABLE  </span></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">isInterrupted</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">, thread.</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">() TERMINATED  </span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">So my thread was interrupted</span><span style="color:#F97583">!</span><span style="color:#E1E4E8"> It seems to say that when a thread terminates, it will reset the interrupt status flag. Looking at the source, it looks like Java maintains the flag at the </span><span style="color:#F97583">native</span><span style="color:#E1E4E8"> level and not as a member of the `Thread` class.</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">``` java</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> native</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> interrupt0</span><span style="color:#E1E4E8">();</span></span></code></pre>
<p>Looking at another run, I got the following</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>thread.isInterrupted() = false, thread.getState() = RUNNABLE</span></span>
<span class="line"><span>thread.isInterrupted() = false, thread.getState() = RUNNABLE  </span></span>
<span class="line"><span>thread.isInterrupted() = false, thread.getState() = RUNNABLE  </span></span>
<span class="line"><span>thread.isInterrupted() = false, thread.getState() = TIMED_WAITING  </span></span>
<span class="line"><span>thread.isInterrupted() = true, thread.getState() = TIMED_WAITING  </span></span>
<span class="line"><span>thread.isInterrupted() = false, thread.getState() = TERMINATED  </span></span></code></pre>
<p>This is even more interesting as it would suggest that an interrupt doesn‚Äôt update the thread‚Äôs state and the interrupt flag atomically.</p>
<blockquote>
<p>It would seem thread termination will reset the interrupt status flag and
that an interrupt doesn‚Äôt update the interrupt status flag and state
atomically.</p>
</blockquote>
<p>As an couple of caveats to the type of test above where I want to check the interrupt status flag, its a good idea to avoid side affects by using the terribly named method <code>Thread.interrupted</code> rather than <code>isInterrupted</code>. I also had to use a stubbed thread to reliably tell if the interrupt was called.</p>
<p>See the code <a href="https://github.com/tobyweston/tempus-fugit/blob/master/src/test/java/com/google/code/tempusfugit/concurrency/ThreadUtilsTest.java">here</a>.</p>  </div> <div class="giscus-wrapper" data-astro-cid-2s6z27su><div class="giscus-divider" data-astro-cid-2s6z27su><span class="giscus-divider-label" data-astro-cid-2s6z27su>Discussion</span></div><div class="giscus" id="giscus-container" data-astro-cid-2s6z27su></div></div><script type="module">const repo = "tobyweston/blog";
const repoId = "MDEwOlJlcG9zaXRvcnkzMzUyNTYw";
const category = "General";
const categoryId = "DIC_kwDOADMn8M4C3bWR";

    function loadGiscus() {
      const container = document.getElementById('giscus-container');
      if (!container) return;

      const script = document.createElement('script');
      script.src            = 'https://giscus.app/client.js';
      script.setAttribute('data-repo',              repo);
      script.setAttribute('data-repo-id',           repoId);
      script.setAttribute('data-category',          category);
      script.setAttribute('data-category-id',       categoryId);
      script.setAttribute('data-mapping',           'pathname');
      script.setAttribute('data-strict',            '0');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata',     '0');
      script.setAttribute('data-input-position',    'top');
      script.setAttribute('data-theme',             'light');
      script.setAttribute('data-lang',              'en');
      script.setAttribute('data-loading',           'lazy');
      script.crossOrigin    = 'anonymous';
      script.async          = true;
      container.appendChild(script);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
      loadGiscus();
    }
  </script> </article> </div>  </main> <footer class="py-8 border-t border-gray-200 mt-12"> <div class="container mx-auto px-4 text-center"> <p class="text-xs text-gray-600">&copy; 2008-2026 Toby Weston. All rights reserved. (see some old <a class="text-gray-600 hover:text-sky-600" href="/code/">code</a>)</p> </div> </footer> </body></html>