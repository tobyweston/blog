<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.18.0"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1PVLDLDJQN"></script><script>(function(){const gaId = "G-1PVLDLDJQN";

      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', gaId);
    })();</script><!-- Canonical URL --><link rel="canonical" href="https://baddotrobot.com/blog/2008-12-30-be-explicit-about-ui-thread-in-swt/"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="bad.robot" href="/rss.xml"><!-- Primary Meta Tags --><title>Be Explicit with the UI Thread</title><meta name="title" content="Be Explicit with the UI Thread"><meta name="description" content="Understand the SWT UI thread and how to avoid invalid thread access errors by being explicit about which thread is the main UI thread when testing."><meta name="keywords" content="SWT, UI thread, event dispatching thread, EDT, invalid thread access, Display.sync, Display.async"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://baddotrobot.com/blog/2008-12-30-be-explicit-about-ui-thread-in-swt/"><meta property="og:title" content="Be Explicit with the UI Thread"><meta property="og:description" content="Understand the SWT UI thread and how to avoid invalid thread access errors by being explicit about which thread is the main UI thread when testing."><meta property="og:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><meta property="og:site_name" content="bad.robot"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://baddotrobot.com/blog/2008-12-30-be-explicit-about-ui-thread-in-swt/"><meta property="twitter:title" content="Be Explicit with the UI Thread"><meta property="twitter:description" content="Understand the SWT UI thread and how to avoid invalid thread access errors by being explicit about which thread is the main UI thread when testing."><meta property="twitter:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Be Explicit with the UI Thread","description":"Understand the SWT UI thread and how to avoid invalid thread access errors by being explicit about which thread is the main UI thread when testing.","datePublished":"2008-12-30T00:00:00.000Z","url":"https://baddotrobot.com/blog/2008-12-30-be-explicit-about-ui-thread-in-swt/","author":{"@type":"Person","name":"Toby Weston","url":"https://baddotrobot.com"},"publisher":{"@type":"Person","name":"bad.robot"}}</script><link rel="stylesheet" href="/_astro/index.BiihJROh.css">
<style>.giscus-wrapper[data-astro-cid-2s6z27su]{margin-top:3rem;padding-top:0}.giscus-divider[data-astro-cid-2s6z27su]{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem}.giscus-divider[data-astro-cid-2s6z27su]:before,.giscus-divider[data-astro-cid-2s6z27su]:after{content:"";flex:1;height:1px;background:var(--border)}.giscus-divider-label[data-astro-cid-2s6z27su]{text-transform:uppercase;letter-spacing:.2em;color:var(--accent);font-size:.75rem;font-weight:600;white-space:nowrap}.giscus[data-astro-cid-2s6z27su],.giscus-frame[data-astro-cid-2s6z27su]{width:100%}
</style>
<link rel="stylesheet" href="/_astro/_slug_.Bryw6KM9.css"></head> <body class="bg-white text-gray-900"> <header class="header" data-astro-cid-3ef6ksr2> <div class="header-container" data-astro-cid-3ef6ksr2> <div class="logo-section" data-astro-cid-3ef6ksr2> <a href="/" class="logo-link" data-astro-cid-3ef6ksr2> <img src="/_astro/robot-logo_105x132.N1ZQY9mA_Zj02tT.webp" alt="bad.robot logo" data-astro-cid-3ef6ksr2="true" loading="lazy" decoding="async" fetchpriority="auto" width="84" height="106" class="logo-image"> <div class="logo-text-block" data-astro-cid-3ef6ksr2> <h1 class="logo-title logo-text header-logo-text" data-astro-cid-3ef6ksr2>bad.robot</h1> <h2 class="logo-subtitle logo-subtitle-text header-subtitle" data-astro-cid-3ef6ksr2>good robots do what they&#39;re told</h2> </div> </a> </div> <nav class="nav" data-astro-cid-3ef6ksr2> <a href="/blog" data-astro-cid-3ef6ksr2>Blog</a> <a href="/book" data-astro-cid-3ef6ksr2>Books</a> <a href="/video" data-astro-cid-3ef6ksr2>Videos</a> <a href="/archive" data-astro-cid-3ef6ksr2>Archive</a> </nav> <div id="header-animation-switcher" class="header-switcher" style="display: none;" data-astro-cid-3ef6ksr2> <div class="switcher-buttons" data-astro-cid-3ef6ksr2> <button class="switcher-btn active" data-option="1" title="Smooth Fade Only" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>‚ö´</span> </button> <button class="switcher-btn" data-option="2" title="Fade + Gentle Lift" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>‚¨ÜÔ∏è</span> </button> <button class="switcher-btn" data-option="3" title="Slide In Left" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>‚û°Ô∏è</span> </button> <button class="switcher-btn" data-option="4" title="Blur Fade" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>üîÆ</span> </button> <button class="switcher-btn" data-option="5" title="Subtle Scale" data-astro-cid-3ef6ksr2> <span class="btn-icon" data-astro-cid-3ef6ksr2>üìà</span> </button> </div> </div> </div> </header>  <main id="site-main" class="mx-auto w-full max-w-6xl px-4 pt-4">   <div class="py-12"> <article class=""> <!--{heroImage && (--> <!--  <div class="hero-image mb-8">--> <!--    <img src={heroImage} alt={title} class="w-full h-auto rounded-lg shadow-lg" />--> <!--  </div>--> <!--)}--> <div class="article-title-section mb-8"> <p class="detail-kicker">Blog</p> <h1 class="article-title-section h1">Be Explicit with the UI Thread</h1>  <p class="article-description">Understand the SWT UI thread and how to avoid invalid thread access errors by being explicit about which thread is the main UI thread when testing.</p> </div> <div class="article-meta"> <div class="article-date"> <strong>Published:</strong> <time datetime="2008-12-30T00:00:00.000Z"> Dec 30, 2008 </time> </div>  </div> <div class="prose">  <p>Following up from the post <a href="/blog/2008-12-29-swt-support-for-window-licker/">SWT Support in Window Licker</a>.</p>
<p>The thing I found most interesting about looking at this was having to be more explicit about the UI thread. When developing SWT applications, we‚Äôre all aware that accessing almost anything graphical in SWT from any other thread than the UI thread spells ‚Äúinvalid thread access‚Äù, but it was fun to be more explicit about the ‚ÄúUI thread‚Äù.</p>
<p>When I started to look at how I go about writing SWT applications, I noticed that</p>
<ul>
<li>I often run the application from a <code>main</code> method somewhere which runs on the <code>main</code> thread.</li>
<li>I often discover invalid thread access problems at run time.</li>
<li>I often plug the problem by wrapping the offender in a <code>Display.sync(...)</code> or <code>Display.async(...)</code> call.</li>
<li>I often have very few long running processes that need to spawn a thread and update the UI.</li>
</ul>
<p>It wasn‚Äôt until I started looking at being able to run the application from the context of a JUnit test that I started to think in more detail about these.</p>
<h2 id="running-the-application-from-a-main-method">Running the application from a main method</h2>
<p>This seems simple but being more explicit about the UI thread means that this is worth a closer look. I always used to start an SWT application from the <code>main</code> method, in variations of the code below.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> SwtCalculator</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> static</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(String... </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        new</span><span style="color:#B392F0"> SwtCalculator</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> SwtCalculator {</span></span>
<span class="line"><span style="color:#E1E4E8">        display </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Display.</span><span style="color:#B392F0">detDefault</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        shell </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Shell</span><span style="color:#E1E4E8">(display);</span></span>
<span class="line"><span style="color:#E1E4E8">        shell.</span><span style="color:#B392F0">setText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Calculator"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">        // shell setup</span></span>
<span class="line"><span style="color:#B392F0">        startEventLoop</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> startEVentLoop</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        while</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">shell.</span><span style="color:#B392F0">isDisposed</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">display.</span><span style="color:#B392F0">readAndDispatch</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">                display.</span><span style="color:#B392F0">sleep</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">        display.</span><span style="color:#B392F0">dispose</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The default constructor would do or delegate the work to setup the various shells and widgets and finally start the event loop. When using JFace‚Äôs <code>ApplicationWindow</code>, I‚Äôd do pretty much the same thing. Calling <code>window.setBlockOnOpen(true)</code> just shifts the responsibility of starting the event loop to the <code>ApplicationWindow class</code>. If you call <code>window.setBlockOnOpen(false)</code> for example, you have to manually start an event loop.</p>
<p>However you do it, getting into that event loop blocks the client and <strong>it‚Äôs the thread that executes this event loop that is called the UI thread</strong>. It just so happens that most SWT applications will hit that loop from the main thread as you can see from the following partial thread dump.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Name: main</span></span>
<span class="line"><span>State: RUNNABLE</span></span>
<span class="line"><span>Total blocked: 0 Total waited: 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Stack trace:</span></span>
<span class="line"><span>    org.eclipse.swt.internal.win32.OS.WaitMessage(Native Method)</span></span>
<span class="line"><span>    org.eclipse.swt.widgets.Display.sleep(Unknown Source)</span></span>
<span class="line"><span>    com.objogate...SwtCalculator.startEventLoop(SwtCalculator.java:104)</span></span>
<span class="line"><span>    com.objogate...SwtCalculator.main(SwtCalculator.java:113)</span></span></code></pre>
<p>At this point, the SWT event loop is doing its thing, waiting for UI events (mouse clicks, keyboard input etc) and dispatching them to the appropriate listeners. So, we can define what we mean by the UI thread;</p>
<blockquote>
<p>The UI thread or event dispatching thread is the thread that executes the standard SWT event loop.</p>
</blockquote>
<h2 id="running-the-tests-and-gui-in-different-threads">Running the tests and GUI in different threads</h2>
<p>So, if the event loop was called from within say a <code>@Before</code> annotated method in a test, the test would block until the event loop finished, the display would be disposed and any subsequent tests against the GUI elements would quickly discover that they no longer exist.</p>
<p>It should be pretty clear then that in order to test GUI elements the event loop has to be started in a different thread than the tests run in. The gotcha is that the test thread will likely want to interact with this UI thread in order to push buttons and make assertions and that‚Äôs when we get into invalid thread access territory with SWT.</p>
<p>The way I implemented this was to use a class extending <code>Thread</code> to represent the UI thread and to start the event loop in its <code>run()</code> method. The tests can interact with the UI thread by either searching for the display with <code>Display.findDisplay(thread)</code> or by cooperating and ensuring that only the default display is used (retrieving it using <code>Display.getDefault()</code>).</p>
<p>A minor change to the application‚Äôs main method is required to optionally not call the event loop when calling main. For example;</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> static</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(String... args) {</span></span>
<span class="line"><span style="color:#E1E4E8">    SwtCalculator calculator </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> SwtCalculator</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">shouldBlock</span><span style="color:#E1E4E8">(args))</span></span>
<span class="line"><span style="color:#E1E4E8">        calculator.</span><span style="color:#B392F0">startEventLoop</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The tests can then explicitly create a UI thread delegating shell setup to the <code>SwtCalculator</code> class before starting the event loop and allowing the test thread to continue.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Before</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> runTheApplication</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    thread </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> UIThread.</span><span style="color:#B392F0">startNewUIThread</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> UISetupClosure</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> performAdditionalSetup</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">            SwtCalculator.</span><span style="color:#B392F0">main</span><span style="color:#E1E4E8">(DONT_BLOCK_ON_OPEN);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">    ui </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> SwtCalculatorDriver</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Test</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> calculatorCanAddTwoNumbers</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">    // testing the calculator whilst the main thread is running and</span></span>
<span class="line"><span style="color:#6A737D">    // the UI has been started in another thread (from @Before)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">After</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> stopTheApplication</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    thread.</span><span style="color:#B392F0">interrupt</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The <code>UISetupClosure</code> allows the setup code (in this case the main method) to run inside the UI thread. This uses the strategy pattern but an alternative design could just as easily sub-class the <code>UIThread</code> and use the template pattern in a similar way.</p>
<p>The interrupt allows the event loop on the UI thread to be interrupted and stop gracefully.</p>
<p>The following partial thread dump shows it in action. As you can see, an explicit thread has started the event loop (the <code>Display.sleep</code> and <code>WaitMessage</code>
are the hints).</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Name: SWT-Event-Dispatcher-Thread-1</span></span>
<span class="line"><span>State: RUNNABLE</span></span>
<span class="line"><span>Total blocked: 0 Total waited: 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Stack trace:</span></span>
<span class="line"><span>    org.eclipse.swt.internal.win32.OS.WaitMessage(Native Method)</span></span>
<span class="line"><span>    org.eclipse.swt.widgets.Display.sleep(Unknown Source)</span></span>
<span class="line"><span>    com.objogate.wl.swt.UIThread.startEventLoop(UIThread.java:90)</span></span>
<span class="line"><span>    com.objogate.wl.swt.UIThread.run(UIThread.java:68)</span></span>
<span class="line"><span>    - locked java.lang.Class@1d7fbfb</span></span></code></pre>
<p>It was a good exercise exploring the UI thread and I encourage you to take a look at <a href="http://code.google.com/p/windowlicker/">Window Licker</a> (and my <a href="http://windowlicker-users.googlegroups.com/web/window-licker-swt-spike.patch">SWT patch</a>). Have a play and see if you agree with the approach I took above.</p>  </div> <div class="giscus-wrapper" data-astro-cid-2s6z27su><div class="giscus-divider" data-astro-cid-2s6z27su><span class="giscus-divider-label" data-astro-cid-2s6z27su>Discussion</span></div><div class="giscus" id="giscus-container" data-astro-cid-2s6z27su></div></div><script type="module">const repo = "tobyweston/blog";
const repoId = "MDEwOlJlcG9zaXRvcnkzMzUyNTYw";
const category = "General";
const categoryId = "DIC_kwDOADMn8M4C3bWR";

    function loadGiscus() {
      const container = document.getElementById('giscus-container');
      if (!container) return;

      const script = document.createElement('script');
      script.src            = 'https://giscus.app/client.js';
      script.setAttribute('data-repo',              repo);
      script.setAttribute('data-repo-id',           repoId);
      script.setAttribute('data-category',          category);
      script.setAttribute('data-category-id',       categoryId);
      script.setAttribute('data-mapping',           'pathname');
      script.setAttribute('data-strict',            '0');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata',     '0');
      script.setAttribute('data-input-position',    'top');
      script.setAttribute('data-theme',             'light');
      script.setAttribute('data-lang',              'en');
      script.setAttribute('data-loading',           'lazy');
      script.crossOrigin    = 'anonymous';
      script.async          = true;
      container.appendChild(script);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadGiscus);
    } else {
      loadGiscus();
    }
  </script> </article> </div>  </main> <footer class="py-8 border-t border-gray-200 mt-12"> <div class="container mx-auto px-4 text-center"> <p class="text-xs text-gray-600">&copy; 2008-2026 Toby Weston. All rights reserved. (see some old <a class="text-gray-600 hover:text-sky-600" href="/code/">code</a>)</p> </div> </footer> </body></html>