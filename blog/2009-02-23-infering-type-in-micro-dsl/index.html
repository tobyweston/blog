<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.17.3"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><!-- Canonical URL --><link rel="canonical" href="https://baddotrobot.com/blog/2009-02-23-infering-type-in-micro-dsl/"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="bad.robot" href="/rss.xml"><!-- Primary Meta Tags --><title>Inferring the Types in a Micro DSL</title><meta name="title" content="Inferring the Types in a Micro DSL"><meta name="description" content="Java struggles with type inference when multiple generics are in play. Examines how to work around these limitations when building a generic fluent find-in-list DSL."><meta name="keywords" content="Java generics, type inference, fluent API, micro-DSL, wildcard, type safety, NeedleFinder"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://baddotrobot.com/blog/2009-02-23-infering-type-in-micro-dsl/"><meta property="og:title" content="Inferring the Types in a Micro DSL"><meta property="og:description" content="Java struggles with type inference when multiple generics are in play. Examines how to work around these limitations when building a generic fluent find-in-list DSL."><meta property="og:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><meta property="og:site_name" content="bad.robot"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://baddotrobot.com/blog/2009-02-23-infering-type-in-micro-dsl/"><meta property="twitter:title" content="Inferring the Types in a Micro DSL"><meta property="twitter:description" content="Java struggles with type inference when multiple generics are in play. Examines how to work around these limitations when building a generic fluent find-in-list DSL."><meta property="twitter:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Inferring the Types in a Micro DSL","description":"Java struggles with type inference when multiple generics are in play. Examines how to work around these limitations when building a generic fluent find-in-list DSL.","datePublished":"2009-02-23T00:00:00.000Z","url":"https://baddotrobot.com/blog/2009-02-23-infering-type-in-micro-dsl/","author":{"@type":"Person","name":"Toby Weston","url":"https://baddotrobot.com"},"publisher":{"@type":"Person","name":"bad.robot"}}</script><link rel="stylesheet" href="/_astro/index.BIJT_GkW.css">
<link rel="stylesheet" href="/_astro/_slug_.CTb-p3zm.css"><style>img[data-astro-cid-hgbazjtb]{max-width:100%;height:auto}img[data-astro-cid-hgbazjtb].right{float:right;margin:0 0 1.5rem 1.5rem;max-width:50%}img[data-astro-cid-hgbazjtb].left{float:left;margin:0 1.5rem 1.5rem 0;max-width:50%}img[data-astro-cid-hgbazjtb].center{display:block;margin:1.5rem auto}img[data-astro-cid-hgbazjtb].half{max-width:48%}@media (max-width: 768px){img[data-astro-cid-hgbazjtb].right,img[data-astro-cid-hgbazjtb].left{float:none;display:block;margin:1.5rem auto;max-width:100%}}
</style></head> <body class="bg-white text-gray-900"> <header class="header" data-astro-cid-3ef6ksr2> <div class="header-container" data-astro-cid-3ef6ksr2> <div class="logo-section" data-astro-cid-3ef6ksr2> <a href="/" class="logo-link" data-astro-cid-3ef6ksr2> <img src="/_astro/robot-logo_105x132.N1ZQY9mA_Zj02tT.webp" alt="bad.robot logo" data-astro-cid-3ef6ksr2="true" loading="lazy" decoding="async" fetchpriority="auto" width="84" height="106" class="logo-image"> <div class="logo-text-block" data-astro-cid-3ef6ksr2> <h1 class="logo-title logo-text header-logo-text" data-astro-cid-3ef6ksr2>bad.robot</h1> <h2 class="logo-subtitle logo-subtitle-text header-subtitle" data-astro-cid-3ef6ksr2>good robots do what they&#39;re told</h2> </div> </a> </div> <nav class="nav" data-astro-cid-3ef6ksr2> <a href="/blog" data-astro-cid-3ef6ksr2>Blog</a> <a href="/book" data-astro-cid-3ef6ksr2>Books</a> <a href="/video" data-astro-cid-3ef6ksr2>Videos</a> <a href="/archive" data-astro-cid-3ef6ksr2>Archive</a> </nav> </div> </header>  <main id="site-main" class="mx-auto w-full max-w-6xl px-4 pt-4">   <div class="py-12"> <article class=""> <div class="article-title-section mb-8"> <p class="detail-kicker">Blog</p> <h1 class="article-title-section h1">Inferring the Types in a Micro DSL</h1> <p class="article-subtitle">Using generics to create flexible, type-safe fluent APIs in Java</p> <p class="article-description">Java struggles with type inference when multiple generics are in play. Examines how to work around these limitations when building a generic fluent find-in-list DSL.</p> </div> <div class="article-meta"> <div class="article-date"> <strong>Published:</strong> <time datetime="2009-02-23T00:00:00.000Z"> Feb 23, 2009 </time> </div>  </div> <div class="prose">  <p>In a recent <a href="/blog/2009-02-16-more-on-micro-dsls/">post</a>, I was talking about a micro DSL to create a simple “find x in a list” service. The key thing here is that it defines how to look for x in the list. So the list can be a list of anything, not just a list of x’s.</p>
<p>Just to recap then, to find something in a list, the original client code (using a static import) looks like this.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(needle).</span><span style="color:#B392F0">in</span><span style="color:#E1E4E8">(haystack)</span></span></code></pre>
<p>The class (in this case <code>NeedleFinder</code>) implements the DSL and specifically decides in the <code>in</code> method how to compare a <code>Needle</code> object to whatever is in the haystack list. I wanted to create a more generic class so started to implement the <code>ListFinder</code> to use generics and a couple of interesting things came out.</p>
<p>The generified class looks like this.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> final</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> ListFinder</span><span style="color:#E1E4E8">&lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> T target;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#E1E4E8"> List&lt;</span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; list </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> ArrayList&lt;</span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#B392F0"> ListFinder</span><span style="color:#E1E4E8">(T </span><span style="color:#FFAB70">target</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.target </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> target;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> static</span><span style="color:#E1E4E8"> &lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; ListFinder&lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; </span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(T </span><span style="color:#FFAB70">target</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> ListFinder&lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt;(target);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> ListFinder&lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; </span><span style="color:#B392F0">in</span><span style="color:#E1E4E8">(List&lt;</span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; </span><span style="color:#FFAB70">list</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.list </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> ArrayList&lt;</span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt;(list);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> L </span><span style="color:#B392F0">using</span><span style="color:#E1E4E8">(Comparator&lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; </span><span style="color:#FFAB70">comparator</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (L item </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> list) {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (comparator.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(target, item)) {</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#E1E4E8"> item;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> Comparator</span><span style="color:#E1E4E8">&lt;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">L</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#F97583">        boolean</span><span style="color:#B392F0"> equals</span><span style="color:#E1E4E8">(T </span><span style="color:#FFAB70">target</span><span style="color:#E1E4E8">, L </span><span style="color:#FFAB70">item</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>With the following test case showing its usage (the <code>Needle</code> and <code>Bale</code> class aren’t show for brevity).</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> ListFinderTest</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Needle needle </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Needle</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Bob&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Needle missing </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Needle</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Billy&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Bale bale1 </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Bale</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Christian&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Bale bale2 </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Bale</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Bob in disguise&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Bale bale3 </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Bale</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Kelly&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> List&lt;</span><span style="color:#F97583">Bale</span><span style="color:#E1E4E8">&gt; haystack </span><span style="color:#F97583">=</span><span style="color:#B392F0"> asList</span><span style="color:#E1E4E8">(bale1, bale2, bale3);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> ListFinder.Comparator&lt;</span><span style="color:#F97583">Needle</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Bale</span><span style="color:#E1E4E8">&gt; comparator </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> ListFinder.Comparator&lt;</span><span style="color:#F97583">Needle</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Bale</span><span style="color:#E1E4E8">&gt;() {</span></span>
<span class="line"><span style="color:#E1E4E8">        @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> equals</span><span style="color:#E1E4E8">(Needle </span><span style="color:#FFAB70">needle</span><span style="color:#E1E4E8">, Bale </span><span style="color:#FFAB70">bale</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">           return</span><span style="color:#E1E4E8"> bale.name.</span><span style="color:#B392F0">contains</span><span style="color:#E1E4E8">(needle.name);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Test</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> needleFoundInHaystack</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Exception {</span></span>
<span class="line"><span style="color:#B392F0">        assertThat</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(needle).</span><span style="color:#B392F0">in</span><span style="color:#E1E4E8">(haystack).</span><span style="color:#B392F0">using</span><span style="color:#E1E4E8">(comparator), </span><span style="color:#B392F0">is</span><span style="color:#E1E4E8">(bale));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Test</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> needleNotFoundInHaystack</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Exception {</span></span>
<span class="line"><span style="color:#B392F0">        assertThat</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(missing).</span><span style="color:#B392F0">in</span><span style="color:#E1E4E8">(haystack).</span><span style="color:#B392F0">using</span><span style="color:#E1E4E8">(comparator), </span><span style="color:#B392F0">is</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">nullValue</span><span style="color:#E1E4E8">()));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> static</span><span style="color:#E1E4E8"> ListFinder&lt;</span><span style="color:#F97583">Needle</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Bale</span><span style="color:#E1E4E8">&gt; </span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(Needle </span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> ListFinder.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(value);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h2 id="equality">Equality</h2>
<p>Here we’re defining the equality of a <code>Needle</code> in a list of <code>Bale</code> objects to be when the name of a <code>Needle</code> is contained in the name of the <code>Bale</code>. A silly example I know but it illustrates that we redefine what we mean by equality for the list finder by implementing the <code>ListFinder.Comparator</code>. The concrete example that spawned the idea was when searching for a <code>Race</code> object inside a list of <code>Event</code> objects; two completely different entities.</p>
<h2 id="type-inference-over-too-many-types">Type inference over too many types</h2>
<p>Anyway, what I thought was interesting about this example was the type inference going on in the static find method. I originally wanted to just use <code>ListFinder.find</code> method directly as in the following.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">ListFinder.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(needle).</span><span style="color:#B392F0">in</span><span style="color:#E1E4E8">(haystack).</span><span style="color:#B392F0">using</span><span style="color:#E1E4E8">(comparator)</span></span></code></pre>
<p>Where <code>ListFinder</code> is statically imported. Usually, I’d rely on type inference here to work out that needle means <code>T</code> and therefore <code>T</code> is of type <code>Needle</code>. However, in the case above, the compiler will complain as the haystack parameter is not of type <code>Object</code>. The trick is that the generic method <code>find</code> in <code>ListFinder</code> needs to infer two types (<code>T</code> and <code>L</code>) but only has enough information for <code>T</code>. So it defaults <code>L</code> to type <code>Object</code>.</p>
<p>The alternative is to use the full notation as follows.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">ListFinder.</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">Needle, Bale</span><span style="color:#F97583">&gt;</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(needle).</span><span style="color:#B392F0">in</span><span style="color:#E1E4E8">(haystack).</span><span style="color:#B392F0">using</span><span style="color:#E1E4E8">(comparator)</span></span></code></pre>
<p>Or (as I’ve done in the test) use an internal method who’s return type gives the compiler enough information to infer both types. I prefer this approach as it makes the DSL expression to find a needle much more readable.</p>
<h2 id="summary">Summary</h2>
<p>So, Java can’t chain methods to infer the types. I didn’t really expect it to be able to so, its a bit much to ask for. Although it would be pretty sweet if it could.</p>
<p>One last thing, <a href="http://codewax.blogspot.com/">Ray Barlow</a> was showing me a <a href="http://docs.codehaus.org/display/JEDI/Home">Jedi</a> alternative to the finder. If we’re lucky, he might blog about it. It seems Jedi offers some measure of residence against the proliferation of anonymous inner classes in lieu of closures but in all honestly, I just wanted to get in some big words in before
signing off. TTFN.</p>
<h2 id="recommended-reading">Recommended Reading</h2>
<ul>
<li><a href="http://www.amazon.co.uk/gp/product/0321712943/ref=as_li_ss_tl?ie=UTF8&camp=1634&creative=19450&creativeASIN=0321712943&linkCode=as2&tag=baddotrobot-21">Domain Specific Languages (Addison-Wesley Signature)</a>, Martin Fowler</li>
<li><a href="http://www.amazon.co.uk/gp/product/1935182455/ref=as_li_ss_tl?ie=UTF8&camp=1634&creative=19450&creativeASIN=1935182455&linkCode=as2&tag=baddotrobot-21">DSLs in Action</a>, DSLs in Action</li>
<li><a href="http://www.amazon.co.uk/gp/product/1934356999/ref=as_li_ss_tl?ie=UTF8&camp=1634&creative=19450&creativeASIN=1934356999&linkCode=as2&tag=baddotrobot-21">The Definitive ANTLR 4 Reference: Building Domain-Specific Languages (Pragmatic Programmers)</a>, Terence Parr</li>
</ul>  </div> </article> </div>  </main> <footer class="py-8 border-t border-gray-200 mt-12"> <div class="container mx-auto px-4 text-center"> <p class="text-xs text-gray-600">&copy; 2008-2026 Toby Weston. All rights reserved. (see some old <a class="text-gray-600 hover:text-sky-600" href="/code/">code</a>)</p> </div> </footer> </body></html>