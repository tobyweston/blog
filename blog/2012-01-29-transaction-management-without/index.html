<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v5.17.3"><meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"><!-- Canonical URL --><link rel="canonical" href="https://baddotrobot.com/blog/2012-01-29-transaction-management-without/"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="bad.robot" href="/rss.xml"><!-- Primary Meta Tags --><title>Transaction Management without the Frameworks</title><meta name="title" content="Transaction Management without the Frameworks"><meta name="description" content="Avoid declarative transaction management frameworks like Spring. Roll your own imperative transaction management for more control and testability."><meta name="keywords" content="transaction management, ACID, Spring transactions, imperative vs declarative, unit of work, Java"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://baddotrobot.com/blog/2012-01-29-transaction-management-without/"><meta property="og:title" content="Transaction Management without the Frameworks"><meta property="og:description" content="Avoid declarative transaction management frameworks like Spring. Roll your own imperative transaction management for more control and testability."><meta property="og:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><meta property="og:site_name" content="bad.robot"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://baddotrobot.com/blog/2012-01-29-transaction-management-without/"><meta property="twitter:title" content="Transaction Management without the Frameworks"><meta property="twitter:description" content="Avoid declarative transaction management frameworks like Spring. Roll your own imperative transaction management for more control and testability."><meta property="twitter:image" content="https://baddotrobot.com/images/heroes/java-code.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Transaction Management without the Frameworks","description":"Avoid declarative transaction management frameworks like Spring. Roll your own imperative transaction management for more control and testability.","datePublished":"2012-01-29T00:00:00.000Z","url":"https://baddotrobot.com/blog/2012-01-29-transaction-management-without/","author":{"@type":"Person","name":"Toby Weston","url":"https://baddotrobot.com"},"publisher":{"@type":"Person","name":"bad.robot"}}</script><link rel="stylesheet" href="/_astro/index.CzF6U4o9.css">
<link rel="stylesheet" href="/_astro/_slug_.DbZHOt6G.css"></head> <body class="bg-white text-gray-900"> <header class="header" data-astro-cid-3ef6ksr2> <div class="header-container" data-astro-cid-3ef6ksr2> <div class="logo-section" data-astro-cid-3ef6ksr2> <a href="/" class="logo-link" data-astro-cid-3ef6ksr2> <img src="/_astro/robot-logo_105x132.N1ZQY9mA_Zj02tT.webp" alt="bad.robot logo" data-astro-cid-3ef6ksr2="true" loading="lazy" decoding="async" fetchpriority="auto" width="84" height="106" class="logo-image"> <div class="logo-text-block" data-astro-cid-3ef6ksr2> <h1 class="logo-title logo-text header-logo-text" data-astro-cid-3ef6ksr2>bad.robot</h1> <h2 class="logo-subtitle logo-subtitle-text header-subtitle" data-astro-cid-3ef6ksr2>good robots do what they&#39;re told</h2> </div> </a> </div> <nav class="nav" data-astro-cid-3ef6ksr2> <a href="/blog" data-astro-cid-3ef6ksr2>Blog</a> <a href="/book" data-astro-cid-3ef6ksr2>Books</a> <a href="/video" data-astro-cid-3ef6ksr2>Videos</a> <a href="/archive" data-astro-cid-3ef6ksr2>Archive</a> </nav> </div> </header>  <main id="site-main" class="mx-auto w-full max-w-6xl px-4 pt-4">   <div class="py-12"> <article class=""> <!--{heroImage && (--> <!--  <div class="hero-image mb-8">--> <!--    <img src={heroImage} alt={title} class="w-full h-auto rounded-lg shadow-lg" />--> <!--  </div>--> <!--)}--> <div class="article-title-section mb-8"> <p class="detail-kicker">Blog</p> <h1 class="article-title-section h1">Transaction Management without the Frameworks</h1>  <p class="article-description">Avoid declarative transaction management frameworks like Spring. Roll your own imperative transaction management for more control and testability.</p> </div> <div class="article-meta"> <div class="article-date"> <strong>Published:</strong> <time datetime="2012-01-29T00:00:00.000Z"> Jan 29, 2012 </time> </div>  </div> <div class="prose">  <p>It’s easy to avoid manually managing transactions when frameworks like Spring and containers do a good job of hiding all the details. However, it’s often more advantageous to take the controls and manage your own transactions. We seem to shy away from this but its really straight forward and if it means we’re not tied into yet another framework, why wouldn’t we? Aside from just avoiding frameworks though, how does replacing <code>@Transctional</code> with something bespoke really help us?</p>
<p>Moving from a declarative approach to a more imperative one can help us with testing and by virtue; <em>composability</em>. We can move from something which can only be tested using the framework or container (implying an integration or end-to-end style test) to a more focused style (without the need of said frameworks or containers). If we manage things ourselves and are explicit about the transactional boundaries in production code, we can be more lightweight in our tests.</p>
<p>Let’s take a look at an example in detail.</p>
<p>It’s probably helpful to be clear what we mean by a <em>unit of work</em> here. Intimately related to the idea of a database transaction, a unit of work is a series of database operations that when applied together adhere to all the transactional characteristics (<em>atomic</em>, <em>coherent</em>, <em>isolated</em> and <em>durable</em>). For example, when updating the database to increment one bank account and decrementing another, things should be atomic (both operations happen or neither does), consistent (the bank accounts actually exist), isolated (protected from concurrent updates to the same accounts) and durable (permanently applied). Describing both operations as a unit of work and applying then transactionally achieves this.</p>
<p>So we can think of the unit of work as something that can be executed and when it is, it’ll be under the conditions described above.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> UnitOfWork</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">R</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#F97583"> extends</span><span style="color:#F97583"> Exception</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    R </span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8">(SessionProvider </span><span style="color:#FFAB70">sessionProvider</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> E;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Something that would be responsible for executing the unit of work might look like this.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> UnitOfWorkRunner</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    &#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#F97583"> extends</span><span style="color:#F97583"> Exception</span><span style="color:#E1E4E8">> T </span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(UnitOfWork&#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">unitOfWork</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Throwable;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>When it comes to using Hibernate, we might have a concrete <code>UnitOfWorkRunner</code> look something like the following. The key thing here is that the transaction management is handled here, its a simple try catch finally pattern and as you can see, is very simple.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> TransactionalUnitOfWorkRunner</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> UnitOfWorkRunner</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> SessionProvider sessionProvider;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> TransactionalUnitOfWorkRunner</span><span style="color:#E1E4E8">(SessionProvider </span><span style="color:#FFAB70">sessionProvider</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.sessionProvider </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sessionProvider;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> &#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#F97583"> extends</span><span style="color:#F97583"> Exception</span><span style="color:#E1E4E8">> T </span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(UnitOfWork&#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">unitOfWork</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Throwable {</span></span>
<span class="line"><span style="color:#E1E4E8">        Session session </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sessionProvider.</span><span style="color:#B392F0">getCurrentSession</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        Transaction transaction </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> session.</span><span style="color:#B392F0">beginTransaction</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            T result </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> unitOfWork.</span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8">(sessionProvider);</span></span>
<span class="line"><span style="color:#E1E4E8">            transaction.</span><span style="color:#B392F0">commit</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> result;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (Throwable </span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            transaction.</span><span style="color:#B392F0">rollback</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#E1E4E8"> e;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (session.</span><span style="color:#B392F0">isOpen</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">                session.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> static</span><span style="color:#E1E4E8"> &#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#F97583"> extends</span><span style="color:#F97583"> Exception</span><span style="color:#E1E4E8">> T </span><span style="color:#B392F0">runInTransaction</span><span style="color:#E1E4E8">(SessionProvider </span><span style="color:#FFAB70">sessionProvider</span><span style="color:#E1E4E8">, UnitOfWork&#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">E</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">unitOfWork</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Throwable {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> TransactionalUnitOfWorkRunner</span><span style="color:#E1E4E8">(sessionProvider).</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(unitOfWork);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>It’s this class and interface that allows us to be explicit about our transactional boundary. Clients to this define the transaction boundary. In most containers and frameworks, the transactional boundary is around the request/response cycle and the developer has little influence. Using the <code>UnitOfWorkRunner</code> directly in your code gives more control over this. You can use a servlet filter to achieve a similar request/response scoped transaction or you can be finer grained and produce what I prefer; a transaction scoped to a coherent <em>business operation</em>.</p>
<p>For example, lets have a interface describing current account business functions that work on bank account entities. The <code>CurrentAccount</code> interface represents business functions and should define the transactional boundary. The <code>BankAccount</code> on the other hand represents the entities involved which themselves are stored in an <code>Accounts</code> <em>repostiory</em>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#6A737D">// "business" operations</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> CurrentAccount</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">   void</span><span style="color:#B392F0"> deposit</span><span style="color:#E1E4E8">(From&#x3C;</span><span style="color:#F97583">BankAccount</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">from</span><span style="color:#E1E4E8">, To&#x3C;</span><span style="color:#F97583">BankAccount</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">to</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>When we implement the <code>CurrentAccount</code>, we can define the transactional behavior as a separate concern from the business behavior. For example,</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">Accounts repository </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> AccountRepository</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">CurrentAccount currentAccount </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> AcmeBankCurrentAccount</span><span style="color:#E1E4E8">(repository);</span></span>
<span class="line"><span style="color:#E1E4E8">CurrentAccount transactionally </span><span style="color:#F97583">=</span><span style="color:#B392F0"> transactionally</span><span style="color:#E1E4E8">(sessionProvider, currentAccount);</span></span>
<span class="line"><span style="color:#6A737D">// ...</span></span>
<span class="line"><span style="color:#E1E4E8">transactionally.</span><span style="color:#B392F0">deposit</span><span style="color:#E1E4E8">(...);</span></span></code></pre>
<p>Where <code>transactionally</code> is a statically imported creation method that wires up the <code>AcmeBankCurrentAccount</code> (the business services) with transactional behavior. It does this via decoration but essentially creates an anonymous <code>UnitOfWork</code> in which to execute the business operation within.</p>
<p>The full class looks like this</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> TransactionWrapper</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#F97583">R</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">implements</span><span style="color:#B392F0"> InvocationHandler</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> SessionProvider sessionProvider;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> R delegate;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> static</span><span style="color:#E1E4E8"> &#x3C;</span><span style="color:#F97583">R</span><span style="color:#E1E4E8">> R </span><span style="color:#B392F0">transactionally</span><span style="color:#E1E4E8">(SessionProvider </span><span style="color:#FFAB70">sessionProvider</span><span style="color:#E1E4E8">, R </span><span style="color:#FFAB70">object</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> (R) Proxy.</span><span style="color:#B392F0">newProxyInstance</span><span style="color:#E1E4E8">(object.</span><span style="color:#B392F0">getClass</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">getClassLoader</span><span style="color:#E1E4E8">(), object.</span><span style="color:#B392F0">getClass</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">getInterfaces</span><span style="color:#E1E4E8">(), </span><span style="color:#F97583">new</span><span style="color:#B392F0"> TransactionWrapper</span><span style="color:#E1E4E8">(sessionProvider, object));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> TransactionWrapper</span><span style="color:#E1E4E8">(SessionProvider </span><span style="color:#FFAB70">sessionProvider</span><span style="color:#E1E4E8">, R </span><span style="color:#FFAB70">delegate</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.sessionProvider </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sessionProvider;</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.delegate </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> delegate;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Object </span><span style="color:#B392F0">invoke</span><span style="color:#E1E4E8">(Object </span><span style="color:#FFAB70">proxy</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> Method </span><span style="color:#FFAB70">method</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">final</span><span style="color:#F97583"> Object</span><span style="color:#E1E4E8">[] </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Throwable {</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> TransactionalUnitOfWorkRunner</span><span style="color:#E1E4E8">(sessionProvider).</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> UnitOfWork&#x3C;</span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Exception</span><span style="color:#E1E4E8">>() {</span></span>
<span class="line"><span style="color:#E1E4E8">                @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">                public</span><span style="color:#E1E4E8"> Object </span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8">(SessionProvider </span><span style="color:#FFAB70">sessionProvider</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Exception {</span></span>
<span class="line"><span style="color:#F97583">                    return</span><span style="color:#E1E4E8"> method.</span><span style="color:#B392F0">invoke</span><span style="color:#E1E4E8">(delegate, args);</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">            });</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (InvocationTargetException </span><span style="color:#FFAB70">throwable</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#E1E4E8"> throwable.</span><span style="color:#B392F0">getTargetException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The underlying business functionality within the <code>AcmeBankCurrentAccount</code> isn’t concerned with transactions. Instead, its decorated with transactionality and we can use this decorating proxy to wrap any business interface as a transaction.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> AcmeBankCurrentAccount</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> CurrentAccount</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> AccountRepository accounts;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> AcmeBankCurrentAccount</span><span style="color:#E1E4E8">(AccountRepository </span><span style="color:#FFAB70">accounts</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.accounts </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> accounts;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> deposit</span><span style="color:#E1E4E8">(From&#x3C;</span><span style="color:#F97583">BankAccountIdentifier</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">from</span><span style="color:#E1E4E8">, To&#x3C;</span><span style="color:#F97583">BankAccountIdentifier</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">to</span><span style="color:#E1E4E8">, Amount </span><span style="color:#FFAB70">amount</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> Throwable {</span></span>
<span class="line"><span style="color:#E1E4E8">        BankAccount benefactor </span><span style="color:#F97583">=</span><span style="color:#E1E4E8">  accounts.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(from.</span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">        BankAccount beneficiary </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> accounts.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(to.</span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">        benefactor.</span><span style="color:#B392F0">withdraw</span><span style="color:#E1E4E8">(amount);</span></span>
<span class="line"><span style="color:#E1E4E8">        beneficiary.</span><span style="color:#B392F0">deposit</span><span style="color:#E1E4E8">(amount);</span></span>
<span class="line"><span style="color:#E1E4E8">        accounts.</span><span style="color:#B392F0">save</span><span style="color:#E1E4E8">(benefactor);</span></span>
<span class="line"><span style="color:#E1E4E8">        accounts.</span><span style="color:#B392F0">save</span><span style="color:#E1E4E8">(beneficiary);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This can come in handy when testing as we can isolate and test the different responsibilities. We’re also left with a handy framework to add ad-hoc data directly to the database and it’s easy enough to wire up an in-memory only <code>UnitOfWorkRunner</code>. Back to the point earlier about composability, the overall approach leaves us with loosely composed objects which combine to provide high level behavior. The composites are simpler than the sum of its parts to borrow a phrase from <a href="http://www.growing-object-oriented-software.com/">GOOS</a>.</p>  </div> </article> </div>  </main> <footer class="py-8 border-t border-gray-200 mt-12"> <div class="container mx-auto px-4 text-center"> <p class="text-xs text-gray-600">&copy; 2008-2026 Toby Weston. All rights reserved. (see some old <a class="text-gray-600 hover:text-sky-600" href="/code/">code</a>)</p> </div> </footer> </body></html>