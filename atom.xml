<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[bad.robot]]></title>
  <link href="http://www.baddotrobot.com/atom.xml" rel="self"/>
  <link href="http://www.baddotrobot.com/"/>
  <updated>2012-02-10T18:30:41+00:00</updated>
  <id>http://www.baddotrobot.com/</id>
  <author>
    <name><![CDATA[Toby Weston]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Transaction Management without the Frameworks]]></title>
    <link href="http://www.baddotrobot.com/blog/2012/01/29/transaction-management-without/"/>
    <updated>2012-01-29T00:00:00+00:00</updated>
    <id>http://www.baddotrobot.com/blog/2012/01/29/transaction-management-without</id>
    <content type="html"><![CDATA[<p>It&#8217;s easy to avoid manually managing transactions when frameworks like Spring and
containers do a good job of hiding all the details. However, it&#8217;s often more advantageous
to take the controls and manage your own transactions. We seem to shy away from this but its really straight forward and if it means we&#8217;re not tied into yet another framework, why wouldn&#8217;t we?
 Aside from just avoiding frameworks though, how does replacing <code>@Transctional</code> with something bespoke really help us?</p>

<p>Moving from a declarative approach to a more imperative one can help us with
testing and by virtue; <em>composability</em>. We can move from something which can
only be tested using the framework or container (implying an integration or
end-to-end style test) to a more focused style (without the need of said
frameworks or containers). If we manage things ourselves and are explicit
about the transactional boundaries in production code, we can be more
lightweight in our tests.</p>

<!-- more -->


<p>Lets take a look at an example in detail.</p>

<p>It&#8217;s probably helpful to be clear what we mean by a <em>unit of work</em> here.
Intimately related to the idea of a database transaction, a unit of work is a
series of database operations that when applied together adhere to all the
transactional characteristics (<em>atomic</em>, <em>coherent</em>, <em>isolated</em> and
<em>durable</em>). For example, when updating the database to increment one bank
account and decrementing another, things should be atomic (both operations
happen or neither does), consistent (the bank accounts actually exist),
isolated (protected from concurrent updates to the same accounts) and durable
(permanently applied). Describing both operations as a unit of work and
applying then transactionally achieves this.</p>

<p>So we can think of the unit of work as something that can be executed and when
it is, it&#8217;ll be under the conditions described above.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UnitOfWork</span><span class="o">&lt;</span><span class="n">R</span><span class="o">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">R</span> <span class="nf">execute</span><span class="o">(</span><span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">E</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Something that would be responsible for executing the unit of work might look like this.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UnitOfWorkRunner</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">run</span><span class="o">(</span><span class="n">UnitOfWork</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">unitOfWork</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When it comes to using Hibernate, we might have a concrete <code>UnitOfWorkRunner</code>
look something like the following. The key thing here is that the transaction
management is handled here, its a simple try catch finally pattern and as you
can see, is very simple.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionalUnitOfWorkRunner</span> <span class="kd">implements</span> <span class="n">UnitOfWorkRunner</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">TransactionalUnitOfWorkRunner</span><span class="o">(</span><span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">sessionProvider</span> <span class="o">=</span> <span class="n">sessionProvider</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">run</span><span class="o">(</span><span class="n">UnitOfWork</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">unitOfWork</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sessionProvider</span><span class="o">.</span><span class="na">getCurrentSession</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Transaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">T</span> <span class="n">result</span> <span class="o">=</span> <span class="n">unitOfWork</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">sessionProvider</span><span class="o">);</span>
</span><span class='line'>            <span class="n">transaction</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">transaction</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">isOpen</span><span class="o">())</span>
</span><span class='line'>                <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">E</span> <span class="kd">extends</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">runInTransaction</span><span class="o">(</span><span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">,</span> <span class="n">UnitOfWork</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">unitOfWork</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">TransactionalUnitOfWorkRunner</span><span class="o">(</span><span class="n">sessionProvider</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">unitOfWork</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s this class and interface that allows us to be explicit about our
transactional boundary. Clients to this define the transaction boundary. In
most containers and frameworks, the transactional boundary is around the
request/response cycle and the developer has little influence. Using the
<code>UnitOfWorkRunner</code> directly in your code gives more control over this. You can
use a servlet filter to achieve a similar request/response scoped transaction
or you can be finer grained and produce what I prefer; a transaction scoped to
a coherent <em>business operation</em>.</p>

<p>For example, lets have a interface describing current account business
functions that work on bank account entities. The <code>CurrentAccount</code> interface
represents business functions and should define the transactional boundary.
The <code>BankAccount</code> on the other hand represents the entities involved which
themselves are stored in an <code>Accounts</code> <em>repostiory</em>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">// &quot;business&quot; operations</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CurrentAccount</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">deposit</span><span class="o">(</span><span class="n">From</span><span class="o">&lt;</span><span class="n">BankAccount</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="n">To</span><span class="o">&lt;</span><span class="n">BankAccount</span><span class="o">&gt;</span> <span class="n">to</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we implement the <code>CurrentAccount</code>, we can define the transactional
behavior as a separate concern from the business behavior. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Accounts</span> <span class="n">repository</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountRepository</span><span class="o">();</span>
</span><span class='line'><span class="n">CurrentAccount</span> <span class="n">currentAccount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AcmeBankCurrentAccount</span><span class="o">(</span><span class="n">repository</span><span class="o">);</span>
</span><span class='line'><span class="n">CurrentAccount</span> <span class="n">transactionally</span> <span class="o">=</span> <span class="n">transactionally</span><span class="o">(</span><span class="n">sessionProvider</span><span class="o">,</span> <span class="n">currentAccount</span><span class="o">);</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="n">transactionally</span><span class="o">.</span><span class="na">deposit</span><span class="o">(...);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where <code>transactionally</code> is a statically imported creation method that wires up
the <code>AcmeBankCurrentAccount</code> (the business services) with transactional
behavior. It does this via decoration but essentially creates an anonymous
<code>UnitOfWork</code> in which to execute the business operation within.</p>

<p>The full class looks like this</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionWrapper</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">R</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">R</span> <span class="n">transactionally</span><span class="o">(</span><span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">,</span> <span class="n">R</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">(</span><span class="n">R</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span> <span class="k">new</span> <span class="n">TransactionWrapper</span><span class="o">(</span><span class="n">sessionProvider</span><span class="o">,</span> <span class="n">object</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">TransactionWrapper</span><span class="o">(</span><span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">,</span> <span class="n">R</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">sessionProvider</span> <span class="o">=</span> <span class="n">sessionProvider</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">TransactionalUnitOfWorkRunner</span><span class="o">(</span><span class="n">sessionProvider</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="k">new</span> <span class="n">UnitOfWork</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Exception</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span>
</span><span class='line'>                <span class="kd">public</span> <span class="n">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="n">SessionProvider</span> <span class="n">sessionProvider</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">delegate</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">});</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getTargetException</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The underlying business functionality within the <code>AcmeBankCurrentAccount</code>
isn&#8217;t concerned with transactions. Instead, its decorated with
transactionality and we can use this decorating proxy to wrap any business
interface as a transaction.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AcmeBankCurrentAccount</span> <span class="kd">implements</span> <span class="n">CurrentAccount</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AccountRepository</span> <span class="n">accounts</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">AcmeBankCurrentAccount</span><span class="o">(</span><span class="n">AccountRepository</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">accounts</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deposit</span><span class="o">(</span><span class="n">From</span><span class="o">&lt;</span><span class="n">BankAccountIdentifier</span><span class="o">&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="n">To</span><span class="o">&lt;</span><span class="n">BankAccountIdentifier</span><span class="o">&gt;</span> <span class="n">to</span><span class="o">,</span> <span class="n">Amount</span> <span class="n">amount</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">BankAccount</span> <span class="n">benefactor</span> <span class="o">=</span>  <span class="n">accounts</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
</span><span class='line'>        <span class="n">BankAccount</span> <span class="n">beneficiary</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">to</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
</span><span class='line'>        <span class="n">benefactor</span><span class="o">.</span><span class="na">withdraw</span><span class="o">(</span><span class="n">amount</span><span class="o">);</span>
</span><span class='line'>        <span class="n">beneficiary</span><span class="o">.</span><span class="na">deposit</span><span class="o">(</span><span class="n">amount</span><span class="o">);</span>
</span><span class='line'>        <span class="n">accounts</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">benefactor</span><span class="o">);</span>
</span><span class='line'>        <span class="n">accounts</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">beneficiary</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This can come in handy when testing as we can isolate and test the different
responsibilities. We&#8217;re also left with a handy framework to add ad-hoc data
directly to the database and it&#8217;s easy enough to wire up an in-memory only
<code>UnitOfWorkRunner</code>. Back to the point earlier about composability, the overall
approach leaves us with loosely composed objects which combine to provide high
level behavior. The composites are simpler than the sum of its parts to borrow
a phrase from <a href="http://www.growing-object-oriented-software.com/">GOOS</a>.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Java source on Mac]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/10/29/java-source-on-mac/"/>
    <updated>2011-10-29T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/10/29/java-source-on-mac</id>
    <content type="html"><![CDATA[<p>Mostly as a reminder to myself, getting the Java source on your Mac involves the following.</p>

<!-- more -->


<ol>
<li>Go to the <a href="https://developer.apple.com/downloads">Apple Developer Connection downloads page</a>, search for <strong>Java for Mac OS X 10.x Developer Package</strong> where 10.x matches your version of OS X. The developer bundle includes the source whereas the regular software update version does not.</li>
<li>Download and install. Running <code>/Applications/Utilities/Java Preferences.app</code> should now show &#8220;Java SE 6 (System)&#8221; in the list.</li>
<li>Open a Terminal.app window</li>
<li><code>cd $JAVA_HOME</code> (aka <code>/System/Library/Frameworks/JavaVM.framework/Home</code>)</li>
<li>Setup a symlink to the source archive with <code>sudo ln -s /Library/Java/JavaVirtualMachines/1.6.0_26-b03-383.jdk/Contents/Home/src.jar</code></li>
<li>And for the JavaDoc, <code>sudo ln -s /Library/Java/JavaVirtualMachines/1.6.0_24-b07-334.jdk/Contents/Home/docs.jar</code></li>
<li>Now point your IDE of choice to the new source folder symlink.</li>
</ol>


<p>Any update to Java will set things up to point to Maven 3, so if you use Maven 2, it&#8217;ll break things with</p>

<pre><code>java.lang.NoClassDefFoundError: org/codehaus/plexus/classworlds/launcher/Launcher
</code></pre>

<p>Reset things by;</p>

<ol>
<li><code>cd /usr/share</code></li>
<li><code>sudo mv maven maven.new</code> (a symlink which should incorrectly be pointing to <code>java/maven-3.0.3)</code></li>
<li><code>sudo ln -s /maven2/install/folder maven</code></li>
<li>run <code>maven -version</code> to check its back up.</li>
<li>Have a cup of tea.</li>
</ol>


<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Reflecting on Interviewing Mistakes]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/08/29/reflecting-on-interviewing-mistakes/"/>
    <updated>2011-08-29T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/08/29/reflecting-on-interviewing-mistakes</id>
    <content type="html"><![CDATA[<p>Recruiting for the next guy on your team is hard. At first glance it doesn&#8217;t seem to be, we&#8217;ve developed techniques like pair tests but as I start to look at it more closely, I&#8217;ve started to notice that even the more progressive techniques don&#8217;t preclude us from making the same mistakes as the traditional interview.</p>

<p>Let&#8217;s take an example from two teams.</p>

<!-- more -->


<p>Team A&#8217;s process starts off by favoring buzz word heavy CVs and CVs that meet
a minimum number of years of experience. A unattended pen and paper test,
characterised by very closed questioning against specialist areas of the
programming language. This might include questions around language syntax
semantics (keywords and modifiers, object equality etc etc). Things like
bubble sorts algorithms are requested. Scores out of 100 are tallied. Things
are fairly black and white.</p>

<p><span class='pullquote-right' data-pullquote='but often an implied hurdle that the candidate must jump is &#8220;has he reached the same conclusion as me on topic X?&#8221; '>
Team B&#8217;s process favors mention of agile experience in the CV. Follow up
questions prompt genuine conversation but often an implied hurdle that the candidate must jump is &#8220;has he reached the same conclusion as me on topic X?&#8221;.
The unattended coding exercise is not a test, at least it should be more of an
exercise to explore the way a candidate approaches things. The team might
require the presence of unit tests and evidence of TDD but should actively not
persecute style or syntax. Something that&#8217;s harder in practice to do than in
theory.
</span></p>

<p>Hopefully, its clear that Team A&#8217;s selection process is heavily biased towards
developers with good memories. It&#8217;s probably unfairly prejudice against
candidates that haven&#8217;t had specific exposure to specific scenarios /
solutions. I experienced this when I was asked to write a algorithm to
calculate prime numbers with pen and paper. I fumbled through and handed over
my scrawl. I explained that I&#8217;d prefer write tests, experiment with the code
and improve the design; basically to learn as I went along. The response from
the interviewer, looking down at my scribbling, was &#8220;that&#8217;s not really what
we&#8217;re looking for&#8230; have you heard of the Sieve of Eratosthenes?&#8221;. Obviously,
I hadn&#8217;t.</p>

<p>Rather than assess my approach, the interviewer was looking for a specific
piece of knowledge but what for? If I got the job I&#8217;m pretty sure my first
task wouldn&#8217;t be to write something to work out prime numbers. Would that fix
some production problem? Would it introduce a new feature that had no other
solution? No.</p>

<p>A huge part of what we do is learn, or at least it should be. Failure is what
makes us better and in environments where failure is embraced and we write
code that we can (fairly) easily rework, we get better systems (as we refine
our understanding). We never now what the real problems are going to be when
we start a story. The interviewer above simply brushed over this, it seemed he
wanted me to reach the same conclusion he had without explaining the steps I
took to get there. Without any advocacy on my part, how would he know I could
do it again with a different problem?</p>

<blockquote><p>&#8220;Right or wrong answers don&#8217;t really have a place because there&#8217;s never a
right or wrong answer in what we do.&#8221;</p></blockquote>

<p>Having said all that, I&#8217;m sure we&#8217;d all favour a process like Team Bs but I&#8217;m
starting to see that Team B are making at least some of the same mistakes just
in a more subtle way&#8230;</p>

<p>For the CV selection, Team A look for &#8220;spring&#8221;, &#8220;hibernate&#8221; and other
technology buzzwords. Team B look for &#8220;refactoring&#8221;, &#8220;TDD&#8221;, &#8220;XP&#8221; and other
development buzz words, the reason usually cited as being because the
technologies aren&#8217;t as import. Team B are favouring the <em>why</em> over the <em>how</em>,
they&#8217;re assuming given the right approach and smart people, specifics around
technologies can be learnt. Both teams are trying to expose characteristics of
the candidates that mirror their own.</p>

<p>Team B asks candidates to complete a short programming exercise off-line.
Implement a library, a DVD store, a robot explorer, whatever. It should only
take an hour or so and demonstrates the candidates style. I&#8217;ve certainly seen
it as an effective tool to eliminate people that really can&#8217;t code for toffee
but I&#8217;ve also seen people fall into the same old trap and eliminate people who
missed something specific hidden there. A trivial example might be &#8220;oh! they
didn&#8217;t use dependency injection. Fail!&#8221;.</p>

<p>Team B&#8217;s pair test should be a great way to understand how a candidate
operates in front of an IDE and if you&#8217;ll actually be able to work with him. A
bit like the unattended test, it&#8217;s a good way to eliminate extreme cases. If
the candidate behaves completely anti-socially, wont listen and codes like mad
man, you can probably reject him with confidence. It&#8217;s easy to let bad
interview habits creep in though; to focus more on some obscure gotcha in the
code than how the candidate is actually pairing.</p>

<blockquote><p>&#8220;I think the problem with both these techniques (unattended exercise and the
pair test) is when too much specificity comes in at the start. When you are
looking for something specific, you&#8217;ll often be disappointed.&#8221;</p></blockquote>

<p>I&#8217;ve certainly heard myself say &#8220;oh, he didn&#8217;t spot that there was a precision
issue with double there&#8230;&#8221;. In all honesty, I&#8217;d miss that kind of bug as
often as I&#8217;d spot it but I&#8217;d hire me! The upshot there, especially when we
doing a couple of pair tests a week, is to stay focused on why you&#8217;re doing
the pair test and not on the test itself. Are we doing this to see if the
candidate can spot all the traps and pitfalls that we spent so long putting in
or do we want to see how they pair? In my view, if they get the &#8220;right&#8221; answer
is almost irrelevant, it&#8217;s how they explore the problem.</p>

<p>I guess what I&#8217;m reflecting on here is how as a peer group, we pretty much
realise that closed questioning limits our choices and that open ended
questions lead to real conversations that are more relevant to the types of
conversations we have day to day. Right or wrong answers don&#8217;t really have a
place because there&#8217;s never a right or wrong answer in what we do. If I
implement a prime number finder without the Colander of Eratosthenes, am I
wrong? The tests still pass so I must be right? Is Eratosthenes more right?
Despite this realisation though, we can easily fall into a more subtle way of
behaving where we mentally start ticking off specifics for a candidate.</p>

<p>I guess we have to keep reminding ourselves what&#8217;s important and what we&#8217;re
looking for in a candidate. I guess I&#8217;m mellowing in the way I assess
candidates and probably rejected a fair few unfairly in the past. Sorry.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Catching Multiple Exceptions (and rethrowing them all!)]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/08/29/catching-multiple-exceptions-and/"/>
    <updated>2011-08-29T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/08/29/catching-multiple-exceptions-and</id>
    <content type="html"><![CDATA[<p>Sometimes, we may want to catch an exception, temporarily ignoring it to continue work before rethrowing it when its more appropriate to do so. I recently saw a slight variation of this whereby the developer wanted to (potentially) catch multiple exceptions, perform some processing then throw. However, it left the question that if more than one was caught, which exception should we actually rethrow. We certainly don&#8217;t want to loose any information and should really allow the client to catch the exception in a standard way.</p>

<p>This got me thinking about how we should deal with this kind of thing. In the
end, I came up with the idea of a collection class to capture the <code>Exceptions</code>
and a sub-class of <code>Exception</code> to represent an exception containing other,
embedded exceptions. When you&#8217;re done collecting exceptions, you can just
check and rethrow as a new exception type.</p>

<!-- more -->


<p>For example, the domain cleaning class below can throw an exception during the
<code>deleteAll</code> method. Rather than abandon the cleanup of subsequent objects, we
can employ this tactic to continue the cleanup and throw an exception
containing the underlying problems when we&#8217;re done.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DomainCleaner</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">(</span><span class="n">Domain</span> <span class="n">domain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CompositeException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Exceptions</span> <span class="n">exceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exceptions</span><span class="o">();</span>
</span><span class='line'>        <span class="n">clean</span><span class="o">(</span><span class="n">domain</span><span class="o">.</span><span class="na">customers</span><span class="o">(),</span> <span class="n">exceptions</span><span class="o">);</span>
</span><span class='line'>        <span class="n">clean</span><span class="o">(</span><span class="n">domain</span><span class="o">.</span><span class="na">suppliers</span><span class="o">(),</span> <span class="n">exceptions</span><span class="o">);</span>
</span><span class='line'>        <span class="n">clean</span><span class="o">(</span><span class="n">domain</span><span class="o">.</span><span class="na">invoices</span><span class="o">(),</span> <span class="n">exceptions</span><span class="o">);</span>
</span><span class='line'>        <span class="n">exceptions</span><span class="o">.</span><span class="na">checkAndThrow</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">(</span><span class="n">Repository</span> <span class="n">repository</span><span class="o">,</span> <span class="n">Exceptions</span> <span class="n">exceptions</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="o">((</span><span class="n">TestRepository</span><span class="o">)</span> <span class="n">repository</span><span class="o">).</span><span class="na">deleteAll</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RepositoryException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">exceptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We simply add to the exception collection class (<code>exceptions.add(e)</code>) and then
when we&#8217;re done, we can check it and throw a composite exception if needed
with <code>exceptions.checkAndThrow()</code>.</p>

<p>So far, we&#8217;ve only been interested in the fact that multiple exception can be
handled and so haven&#8217;t needed to programmatically query for specific exception
types. For example, we&#8217;ve only needed this up until now.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// ... something that calls checkAndThrow()</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CompositeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// ... this is enough for now</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The details of the classes are below.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exceptions</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="n">Exception</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Exception</span><span class="o">&gt;</span> <span class="n">exceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Exception</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">exceptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Exception</span><span class="o">&gt;</span> <span class="n">iterator</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">exceptions</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkAndThrow</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CompositeException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">exceptions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CompositeException</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>toString()</code> implementation below outputs the embedded exceptions in a way
that is consistent with how you&#8217;d expect to see regular exceptions.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompositeException</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Exceptions</span> <span class="n">exceptions</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">CompositeException</span><span class="o">(</span><span class="n">Exceptions</span> <span class="n">exceptions</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">(</span><span class="s">&quot;composite exception was thrown with embedded exceptions (see details)&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">exception</span> <span class="o">:</span> <span class="n">exceptions</span><span class="o">)</span>
</span><span class='line'>            <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\t&#39;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="k">new</span> <span class="n">ExceptionToString</span><span class="o">(</span><span class="n">exception</span><span class="o">).</span><span class="na">toString</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\n&#39;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%s\n{composite exceptions=\n%s}\n%s&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="kd">super</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Loggin is still evil but...]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/06/22/loggin-is-still-evil-but/"/>
    <updated>2011-06-22T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/06/22/loggin-is-still-evil-but</id>
    <content type="html"><![CDATA[<p>In a <a href="http://pequenoperro.blogspot.com/2010/10/logging-is-evil-but.html">previous post</a>, I was going on about how evil logging is. How it&#8217;s often confused as a requirement and often badly misused. The upshot of the post was that if you&#8217;re going to log stuff, in our case using Log4J, lets be honest about it and test it. We should be able to say upfront what&#8217;s important to log, in what situations and at what log level. Sounds like a straight forward case of test first.</p>

<p>Mocking Log4J however can be a real pain. I&#8217;ve managed it in the past using
Apache&#8217;s logging abstraction and configuring it to use Log4J under the covers
but in my previous post, I demonstrated a slightly easier way. A helper class
called Log4J that we can use to represent the logging system and that we can
make assertions against. Pretty cool so far.</p>

<!-- more -->


<p>There was one caveat, I wasn&#8217;t entirely happy with the fact that the class
would rely on your external Log4J configuration. To assert that a log message
appeared at the level INFO for example, you&#8217;d have to make sure that the test
environment sets up the appropriate class to log at that level. It made for a
kind of integration / environmental test which in some cases might be a
sensible test but for the most part, I kept seeing test failures down to
configuration on different environments. Yuk.</p>

<p>So I updated the helper class to include a log level override which will
ignore what the actual configuration says. This means you can write less
brittle tests to say things like &#8220;ensure my log message is output at debug
level regardless of the runtime configuration&#8221;.</p>

<p>The updated class looks like this.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log4J</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">StringWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Log4J</span> <span class="nf">appendTo</span><span class="o">(</span><span class="n">Logger</span> <span class="n">logger</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">Log4J</span><span class="o">(</span><span class="n">logger</span><span class="o">,</span> <span class="n">ALL</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Log4J</span> <span class="nf">appendTo</span><span class="o">(</span><span class="n">Logger</span> <span class="n">logger</span><span class="o">,</span> <span class="n">Level</span> <span class="n">level</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">Log4J</span><span class="o">(</span><span class="n">logger</span><span class="o">,</span> <span class="n">level</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Log4J</span><span class="o">(</span><span class="n">Logger</span> <span class="n">logger</span><span class="o">,</span> <span class="n">Level</span> <span class="n">level</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>        <span class="n">WriterAppender</span> <span class="n">appender</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WriterAppender</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleLayout</span><span class="o">(),</span> <span class="n">writer</span><span class="o">);</span>
</span><span class='line'>        <span class="n">appender</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="na">addAppender</span><span class="o">(</span><span class="n">appender</span><span class="o">);</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="na">setLevel</span><span class="o">(</span><span class="n">level</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="na">removeAppender</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">assertThat</span><span class="o">(</span><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">matcher</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">matcher</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which means you can setup to expect a log level at say the ERROR level like
this.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Log4J</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">Log4J</span><span class="o">.</span><span class="na">appendTo</span><span class="o">(</span><span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Post</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">LogLevel</span><span class="o">.</span><span class="na">ERROR</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The make assertions like this (which would fail if the matcher fails or
because its not logged at the expected level.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">logger</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">containsString</span><span class="o">(</span><span class="n">EXCEPTION_MESSAGE</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>I still think logging is evil and try <em>really</em> hard not to use a single log
statement but if you have to, I hope the helper class helps keep you honest in
your tests ;) Have a look at the <a href="http://pequenoperro.blogspot.com/2010/10/logging-is-evil-but.html">previous
post</a> for
more details and extended examples.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JDK7 Artcile in JavaTech Journal]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/06/10/artcile-in-javatech-journal/"/>
    <updated>2011-06-10T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/06/10/artcile-in-javatech-journal</id>
    <content type="html"><![CDATA[<p><a href="http://badrobot.googlecode.com/svn/trunk/bad.robot/JTJ-2011-05.pdf"><img class="right" src="http://jaxenter.com/assets/125/150/JTJ-2011-05.png"></a></p>

<p>My article &#8220;Java the language vs Java the platform&#8221; (about the new release of JDK7) has been published in this months
<a href="http://jaxenter.com/java-tech-journal/">Java Tech Journal</a>. Click on the image to download.</p>

<p>I&#8217;d love to get some feedback, so please feel free to comment here.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[tempus-fugit 1.1 released]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/04/13/tempus-fugit-1.1-released/"/>
    <updated>2011-04-13T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/04/13/tempus-fugit-1.1-released</id>
    <content type="html"><![CDATA[<p>Yesterday, I released the 1.1 version of my micro-library <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a>. From the project&#8217;s website</p>

<blockquote><p>The tempus-fugit library is a small collection of classes and interfaces capturing common abstractions useful when writing concurrent and time sensitive code.</p></blockquote>

<p>It&#8217;s now available from the <a href="http://repo2.maven.org/maven2/com/google/code/tempus-fugit/tempus-%20fugit/">Maven Central</a>
repository having had a bad experience with <a href="http://repo2.maven.org/maven2/com/google/code/tempus-fugit/tempus-%20fugit/">java.net</a>
since their migration (and no longer being able to publish, see this <a href="http://java.net/projects/maven-repository/lists/users/archive/2011-03/message/0">post</a>
and <a href="http://java.net/projects/wagon/lists/users/archive/2011-02/message/0">another</a> if you&#8217;re interested).</p>

<p>See the <a href="http://tempus-fugit.googlecode.com/svn/site/documentation/changes.html">change list</a> for what&#8217;s included in this release.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JDK7 Previewed]]></title>
    <link href="http://www.baddotrobot.com/blog/2011/03/04/jdk-7-previewed/"/>
    <updated>2011-03-04T00:00:00+00:00</updated>
    <id>http://www.baddotrobot.com/blog/2011/03/04/jdk-7-previewed</id>
    <content type="html"><![CDATA[<p>Oracle put out the preview release of JDK7 last month. I guess they felt they had to. So, it&#8217;s not what was once heralded
(will <a href="http://openjdk.java.net/projects/lambda/">8 see lamdas</a>?) but still has one or two interesting language features.
A few that caught my eye include&#8230;</p>

<h3>Type Inference on Generic Object Creation</h3>

<p>Which allows a little brevity to the garrulity of the language, at least
against generic object instantiation where the type can be inferred. For
example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Size</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Shoe</span><span class="o">&gt;&gt;</span> <span class="n">stock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Size</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Shoe</span><span class="o">&gt;&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>can be reduced to</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Size</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Shoe</span><span class="o">&gt;&gt;</span> <span class="n">stock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></code></pre></td></tr></table></div></figure>




<!-- more -->


<p>where the <em>diamond operator</em> can be filled in or inferred from the
declaration. It&#8217;s subtly different than leaving out the generic completely
which will reduce your type to being of <code>Object</code> Things don&#8217;t get much better
than this.</p>

<p>Actually, it does. Just a little. Constructor generics always used to be fun
and that hasn&#8217;t really changed, although with JDK7 you can do a little more.
For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Bob</span><span class="o">&lt;</span><span class="n">Y</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Bob</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">example</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Bob</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">bob</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bob</span><span class="o">&lt;&gt;(</span><span class="s">&quot;yum&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">anotherExample</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Bob</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">bob</span> <span class="o">=</span> <span class="k">new</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">Bob</span><span class="o">&lt;&gt;(</span><span class="s">&quot;yum&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The examples are the same as the one Oracle gives, they both work with JDK7
only and show the <code>Integer</code> type inferred as the class generic (<code>Y</code>) in
combination with the diamond operator. The second example shows new syntax to
explicitly set type of the method generic and give some additional compile
time checks.</p>

<h3>try-with-resource and <code>AutoClosable</code></h3>

<p>Another bugbear with the verbosity of Java has always been the try-catch-
finally syntax. The new language feature try-with-resource allows you to chop
this down some what in combination with auto-closable resources. Here, rather
than the familiar, try-finally to close a resource, you can &#8220;open&#8221; the
resource within the parenthesis of the try statement (as long as the object
implements <code>AutoCloassable</code> and the resource will always close itself in a
<code>finally</code> like way.</p>

<p>For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="nf">example</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(...);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>gets replaced with</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="nf">example</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span><span class="o">(</span><span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(...)</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dr Heinz combined this technique with a way to automatically unlock locked
resources in a <a href="http://www.javaspecialists.eu/archive/Issue190.html">recent news letter</a>.</p>

<p>There may be a little gotcha using this where exceptions can be suppressed and
have to be retrieved using <code>Throwable.getSuppressed()</code>. This seems like it
could be nasty.</p>

<h3>Catching Multiple Exceptions</h3>

<p>This one allows you to catch multiple exceptions using a pipe to separate the
exception types. This looks like another work around for the general grips
with Java but removes the duplicated code you often get catching several
exceptions and treating them in the same way. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I usually end up pushing the code to execute as a <code>Callable</code> and dealing with
the exception in a lamda-like piece of code, or decorating the fragment to
deal with exceptions (logging or wrapping) or even trying really hard to throw
around runtime exceptions, so this one is at odds with my general approach.
Given the example from Oracle above, I suspect this will just facilitate ugly,
jammed in code. It seems to say &#8220;it&#8217;s ok to deal with a bunch of exceptions in
the same way. in fact, we&#8217;ll make it easier for you&#8221; without any warning about
if you actually <em>should</em> be doing this type of thing. The fact the example
above (Oracle&#8217;s example, by the way) logs then re-throws is a smell in it&#8217;s
self. Perhaps I&#8217;m being premenstrual, but I&#8217;m not a fan of this one.</p>

<p>Have a look <a href="http://download.java.net/jdk7/docs/#NewFeature">here</a> for on the
new features and download from
<a href="http://www.oracle.com/technetwork/java/javase/downloads/ea-%20jsp-142245.html">here</a> (unfortunately, not for the Mac).</p>

<p><strong>UPDATE:</strong> An extended version of this post has been published in
<a href="http://pequenoperro.blogspot.com/2011/06/jdk7-artcile-in-javatech-journal.html">May edition of the JavaTech Journal</a>.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Logging is evil but...]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/10/18/logging-is-evil-but/"/>
    <updated>2010-10-18T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/10/18/logging-is-evil-but</id>
    <content type="html"><![CDATA[<p>Logging is a nightmare. I don&#8217;t mean here that conveying information about
exceptional circumstances is a nightmare, I mean the combination of over eager
developers and [<em>insert your current logging framework here</em>] is a recipe
for disaster. We&#8217;ve all seen too much of</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ThisSucks</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">somethingRisky</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SomethingVeryBadException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>   <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>which is just one example where the exception handling policy for the system
(it&#8217;s a system-wide concern remember) is muddled at best. Nothing is saying
that the same exception isn&#8217;t logged elsewhere or that the exception is even
handled correctly or the right people notified. It&#8217;s not ok to just log and
rethrow and every single time we go to declare a new logger, we should think
twice.</p>

<!-- more -->


<p>We&#8217;ve taken this very literally in my current project and everyone is actively
discouraged from instantiating a logger. I&#8217;d rather be explicit that some
exception event has occurred and fire an event that some interested party can
listen for. This makes perfect sense when you think about the huge log files
that someone has to trawl through, armed only with for some vague clue as to
what went wrong, a grep manual and the futile hope that developers actually
log something useful. All without the context of the code to actually guide
them. Good luck.</p>

<p>The disseminated log problem is exacerbated if there is no clear audit trail
tying pieces of information together. In a system with thousands of request
per second, how do you tie the logged request inputs to some stack trace
embedded in the middle of another thousand requests? What should have been a
clear set of requirements from the business (in this case, presumably the
support team) can easily get lost in the technical translation.</p>

<blockquote><p>Logging is evil, but if I really <em>have</em> to log, be honest about it&#8230;</p></blockquote>

<p>Asking the business <em>&#8220;what information do you want to see in the event of x
happening&#8221;</em> rather than assuming they want to see some stack trace in a huge
log can make a lot of sense. We&#8217;re often not logging for ourselves (we have
debuggers for that), we&#8217;re often logging for our customers. If we start to
think about this stuff early, in terms of exception events and their audience,
we can build systems that tell the outside world something meaningful in
flexible ways. We start to define a system wide exception handling policy
rather than relying of the default exception handler (<code>System.out</code> is rarely
the right choice!).</p>

<p>So back to my current project&#8230; people are regularly beaten with a chair leg
for creating loggers but I&#8217;ll admit that on occasion, I&#8217;ve actually logged
stuff and didn&#8217;t resort to some Opus Dei style self-flagellation. Logging is
evil, but if I really <em>have</em> to log, my saving grace is to be explicit about
it. I&#8217;ll hunt down a customer and I&#8217;ll write a test to advertise the fact the
log contains what they asked for.</p>

<p>Most of the common logging frameworks make it troublesome to inject a logger
instance, and I&#8217;m reluctant to subvert behaviour just because some logging
framework wants me to. Logging (or preferably, firing an event) should be
orthogonal to the classes core behaviour, why should I compromise? My
preferred approach is the canonical example of using Aspects, or less
esoterically, using decorators.</p>

<p>For example, I created a interface to handle HTTP POST requests, imaginatively
called <code>Post</code>. Why should I add logging to implementations and open the door
to ad-hoc, erratic logging? I shouldn&#8217;t, but when my implementation
<code>CustomerPost</code> requires logging of the request and response, I can decorate
with a <code>LoggingPost</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingPost</span> <span class="kd">implements</span> <span class="n">Post</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Post</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">LoggingPost</span><span class="o">(</span><span class="n">Post</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">post</span><span class="o">(</span><span class="n">Body</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>       <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>           <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
</span><span class='line'>       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">LOG</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>           <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You might be concerned that the try/catch above looks very similar to the
original negative example. The good thing about our decorated example above is
that by being explicit about this classes responsibility, declaring the usage
in the correct context, we can actually define the system wide policy for
logging the <code>Post</code> calls in one place, without affecting the contract of the
interface. We&#8217;d do this for example, on the system boundary, for example where
the RESTful API is implemented.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Resource</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerServlet</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">Request</span> <span class="n">chuck</span><span class="o">,</span> <span class="n">Response</span> <span class="n">up</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>        <span class="n">customer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoggingPost</span><span class="o">(</span><span class="k">new</span> <span class="n">CustomerPost</span><span class="o">(...));</span>
</span><span class='line'>        <span class="n">customer</span><span class="o">.</span><span class="na">post</span><span class="o">(...)</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our <code>LoggingPost</code> above, we haven&#8217;t even tried to inject a logger in to
make the testing easier. Instead, mostly because I was being lazy, I used the
helper class below. This is intended to represent Log4J in the context of a
test and give access to the logger for assertion purposes.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log4J</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">StringWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Log4J</span> <span class="nf">appendTo</span><span class="o">(</span><span class="n">Logger</span> <span class="n">logger</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">Log4J</span><span class="o">(</span><span class="n">logger</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Log4J</span><span class="o">(</span><span class="n">Logger</span> <span class="n">logger</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>        <span class="n">WriterAppender</span> <span class="n">appender</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WriterAppender</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleLayout</span><span class="o">(),</span> <span class="n">writer</span><span class="o">);</span>
</span><span class='line'>        <span class="n">appender</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="na">addAppender</span><span class="o">(</span><span class="n">appender</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="na">removeAppender</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">assertThat</span><span class="o">(</span><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">matcher</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">matcher</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using it in the test for <code>LoggingPost</code> is shown below</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">JMock</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingPostTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Mockery</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Mockery</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Post</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="n">Post</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Log4J</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">Log4J</span><span class="o">.</span><span class="na">appendTo</span><span class="o">(</span><span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Post</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">EXCEPTION_MESSAGE</span> <span class="o">=</span> <span class="s">&quot;bar bar black sheep...&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldDelegate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">context</span><span class="o">.</span><span class="na">checking</span><span class="o">(</span><span class="k">new</span> <span class="n">Expectations</span><span class="o">()</span> <span class="o">{</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">one</span><span class="o">(</span><span class="n">mock</span><span class="o">).</span><span class="na">post</span><span class="o">(...);</span>
</span><span class='line'>        <span class="o">}});</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">LoggingPost</span><span class="o">(</span><span class="n">mock</span><span class="o">).</span><span class="na">post</span><span class="o">(...);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Test</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldLogWhenExceptionIsThrown</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">postWill</span><span class="o">(</span><span class="n">throwException</span><span class="o">(</span><span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="n">EXCEPTION_MESSAGE</span><span class="o">)));</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">LoggingPost</span><span class="o">(</span><span class="n">mock</span><span class="o">).</span><span class="na">post</span><span class="o">(...);</span>
</span><span class='line'>            <span class="n">fail</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">logger</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span><span class="n">allOf</span><span class="o">(</span><span class="n">containsString</span><span class="o">(</span><span class="s">&quot;ERROR&quot;</span><span class="o">),</span> <span class="n">containsString</span><span class="o">(</span><span class="n">EXCEPTION_MESSAGE</span><span class="o">)));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@After</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cleanupLogger</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="na">clean</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">postWill</span><span class="o">(</span><span class="kd">final</span> <span class="n">Action</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">context</span><span class="o">.</span><span class="na">checking</span><span class="o">(</span><span class="k">new</span> <span class="n">Expectations</span><span class="o">(){{</span>
</span><span class='line'>            <span class="n">allowing</span><span class="o">(</span><span class="n">mock</span><span class="o">);</span> <span class="n">will</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}});</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It relies on nasty statics to dynamically add a logger to Log4J&#8217;s list of
loggers and thereby appending any generated logs to something that the <code>Log4J</code>
test helper can assert on. I can&#8217;t decide if I like this or not. It gives you
an extra test that your class under test is using a logger with the name that
you expect (<code>"Post.class"</code> in the example above), testing your logger
configuration as a by-product.</p>

<p>What I found interesting about this though was that it was always seemed a lot
of effort making some logging framework play nicely with mocks, or writing and
configuring a custom in memory appender and asserting on it. With the above
example, I very quickly added confirmation to existing Log4J infrastructure.
It seemed almost too easy&#8230; so I&#8217;d love to hear your comments and how you
write tests for logging.</p>

<p>PS. Logging is evil.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pairing Honestly]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/08/15/pairing-honestly/"/>
    <updated>2010-08-15T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/08/15/pairing-honestly</id>
    <content type="html"><![CDATA[<p>Recently we had particularly good retrospective where the team {&#8221; were able to admit that each of us has had difference experiences pairing &#8220;}. We were honest in saying that despite having &#8220;done pairing&#8221; we&#8217;d all done different amounts of pairing and that, at times, we weren&#8217;t even sure what we were supposed to get out of it. There can be a fair amount of peer pressure to pair but if the pair don&#8217;t know what they can get out of it, it&#8217;s unlikely to succeed. We should be honest about that. What makes a good pair (see a <a href="http://pequenoperro.blogspot.com/2008/12/what-makes-good-pair.html">previous post</a>) and how do we know that we&#8217;re getting something out of it?</p>

<!-- more -->


<p>Once we honest in our experiences and expectations around pairing, we were
able to be explicit in what we <em>want</em> to achieve. We had the conversation
along the lines of &#8220;do we even believe we <em>could</em> get something out of
pairing? Do we want to try?&#8221; and when the team bought into that idea we could
be explicit about starting from scratch and putting tools in place to help us.</p>

<p>Some techniques I favour include</p>

<ul>
<li><p>when sitting down to start a session, stating explicitly what each individual hopes to get out of the session and what isn&#8217;t helpful. In short, what they think a pairing session should be like.</p></li>
<li><p>each pair can set up one or two &#8220;rules&#8221;, written on cards and placed prominently to remind each other about something they feel is important to the session. For example, I often have a rule &#8220;ask don&#8217;t tell&#8221; to remind me to be asked before I go rambling on about something in the code.</p></li>
<li><p>the silent partner; saying up front that when not driving, the silent partner should hold their tongue and make notes / record a task stack. Interruption is interruption, so be considerate about when to make a comment. This one should be agreed up front, it may or may not be appropriate for your pair.</p></li>
<li><p><strong>most important one of all</strong>; have a mini pair-retrospective at the end of the session. It&#8217;s a great chance to ask the question &#8220;how was that for you?&#8221; and a great way to let the other person know if some aspect didn&#8217;t go well.</p></li>
</ul>


<p>Another useful tool can be the pair stairs. It&#8217;s very easy to avoid pairing
rather than face it&#8217;s challenges so <a href="http://www.natpryce.com/articles/000522.html">pair stairs</a> can be a good way to
keep you honest. Probably the most helpful thing though is
having people on the team that have lots of experience pairing, know what the
team can get out of it and are able to help guide pairing sessions for the
less experienced.</p>

<p>Pairing is hard. It&#8217;s probably one of the hardest things we do as developers
but it can also be one of the most rewarding, personally and for the team as a
whole. Collaboration has given the world some of its greatest achievements but
you have to be honest that in this case, you might have to work for
it.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Lamdas vs. Closures]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/07/13/lamdas-vs-closures/"/>
    <updated>2010-07-13T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/07/13/lamdas-vs-closures</id>
    <content type="html"><![CDATA[<p>When writing Java in a functional style, apart from the verbosity of it all,
it always bugged me about the terminology we use. I tend to talk about
closure-like arguments but revisiting some old University materials when
clearing out the loft, I&#8217;ve adjusted my vocabulary somewhat. Taking the
<code>WaitFor</code> class from <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a>
as an example, passing an anonymous class instance as a parameter to a method
 that will later call the instance is a kind of functional programming. I say
  kind-of because its not really functional programming,
  Java isn&#8217;t a functional language but we can bend it into a style that&#8217;s similar. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="n">waitOrTimeout</span><span class="o">(</span><span class="k">new</span> <span class="n">Condition</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="nd">@Override</span>
</span><span class='line'>   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="na">isRunning</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">},</span> <span class="n">timeout</span><span class="o">(</span><span class="n">seconds</span><span class="o">(</span><span class="mi">5</span><span class="o">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>The anonymous class implementing <code>Condition</code> is evaluated by the method
<code>waitOrTimeout</code> (it&#8217;s that which will call the <code>isSatisfied</code>) method.</p>

<p>The recent shift to this functional style has lead to eager anticipation of
JDK7 and the promise of closures. More accurately however, it&#8217;s the inclusion
of <em>lamdas</em> that we&#8217;re waiting for, not <em>closures</em>. Closures have in fact been
available in Java since 1.1, so what&#8217;s the difference?</p>

<!-- more -->


<h3>Lambs to the Slaughter</h3>

<p>So, we want to be able to define anonymous functions on the fly, the result of
the function is purely dependent on it&#8217;s arguments and this is called a lamda.
Those functions that depend on external values (not just it&#8217;s arguments) are
when closures come into it. The act of binding those external values to the
anonymous function is referred to as <em>closure</em>. After closure, when all
variables have been captured and bound to the function, the term is closed.</p>

<p>For example, the code snippet above will return a new <code>Condition</code> instance on
each invocation. Because it will bind the variable server to the anonymous
function, it will return a closure. To put it another way, we&#8217;ll extract the
anonymous part to a method to explicitly create a new instance, such</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">Condition</span> <span class="nf">isRunning</span><span class="o">(</span><span class="kd">final</span> <span class="n">Server</span> <span class="n">server</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="k">new</span> <span class="nf">Condition</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">server</span><span class="o">.</span><span class="na">isRunning</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>   <span class="o">};</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should make it more obvious that the variable outside the scope of the
anonymous <code>Condition</code> is required (the server variable), each call to the
<code>isRunning</code> method will return a closure over the argument, the instance of
which captures the value of server. Java implements the closure by passing a
reference to the outer scoped (lets say <code>Foo.class</code>) to the anonymous class
(<code>Foo$1.class</code>). The <code>access$000</code> call accesses the appropriate private field
 in the outer class directly in the bytecode</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Foo</span><span class="n">$1</span> <span class="kd">implements</span> <span class="n">Condition</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="n">Foo</span> <span class="k">this</span><span class="n">$0</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Foo$1</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="n">$0</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="na">this</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Foo</span><span class="o">.</span><span class="na">access</span><span class="n">$000</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">this</span><span class="o">).</span><span class="na">isRunning</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, if, we have update the example again, this time removing the out of scope
variable, we&#8217;re left with something like this;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">Condition</span> <span class="nf">isRunning</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="k">new</span> <span class="nf">Condition</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSatisfied</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// optimistic!</span>
</span><span class='line'>      <span class="o">};</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then no out of scope variables are required, the term doesn&#8217;t need to be
closed. The anonymous function that is left is effectively a lamda.</p>

<p>What JDK7 will (finger&#8217;s crossed) bring is more explicit, concise way of
expressing the same ideas. It will support lamdas as a language feature
although I can&#8217;t quite figure out what the example would look like in those
terms. See the <a href="http://cr.openjdk.java.net/%7Emr/lambda%0A/straw-man/">straw man proposal</a> and see if you can figure it out!</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Growing Team Skills]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/07/11/growing-team-skills/"/>
    <updated>2010-07-11T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/07/11/growing-team-skills</id>
    <content type="html"><![CDATA[<p>I love the idea of growing teams, the lure of the gardening analogy is just too strong&#8230; they have to be nurtured to flourish blar blar blar. What is obvious though is that team dynamics are really important and we have to be conscious of how we work together if we want to be able to reflect on how well we, the team, are doing. It&#8217;s useful to understand the strengths and weaknesses of the team, together and individually so that we can a) improve and b) match people to tasks, and teams to projects. It all contributes to a happy working environment.</p>

<p>Often, new or junior developers worry about the barrage of new and unfamiliar
technologies. Technologies are such a small part of what we do in my opinion
but it can be useful to be explicit about individual competencies to re-assure
the bedazzled new developer. In this post, I present a tool I came up with to
help, a kind of competency depth distribution chart (that makes a nice
palindrome so it&#8217;s a good a name as any).</p>

<!-- more -->


<p>It works like this;</p>

<p>As a team, define the technologies that are important / exotic / of interest.
Rank them by importance. Try to limit to around 5-10. Start the distribution
chart, along the Y axis you&#8217;ll list the technologies, ranked by importance and
on the X, the <a href="http://en.wikipedia.org/wiki/Dreyfus_model_of_skill_acquisition">Dreyfus Scale of Competency</a>.
The team must agree on the ranking of technologies and agree on their
understanding of the Dreyfus scale.</p>

<p>Next, each team member grades themselves on the scale for each technology.
It&#8217;s important to be honest. The team can then agree and plot the desired
competency in each area on a separate sheet (the black line in the example
below). Each individual can then see immediately their delta and use it to
focus their personal development.</p>

<p><a href="http://4.bp.blogspot.com/_-uMxV_fCbC4/TDnq1Y3LWYI/AAAAAAAAEoI/6m2PreTjioQ/s1600/depth-chart.png"><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/TDnq1Y3LWYI/AAAAAAAAEoI/6m2PreTjioQ/s640/depth-chart.png"></a></p>

<p>If the team choose to come together and share their individual charts, they&#8217;ll
be able to see how the team compares to their minimum requirements. It might
be that some people are strong in some area and others less so. In this case,
there&#8217;s an obvious knowledge sharing opportunity and it might be that the
urgency to close the delta changes. For example, if there is already an expert
in some technology on the team, the others may not need to stress. Hopefully,
you can start to look at the needs of the team and not the individual. Working
through this as a team can also help build trust which is vital to healthy
plants, sorry, teams.</p>

<p>If the Dreyfus scale seems a little too harsh, you could always try a scale to
reflect general confidence in the area. This tool doesn&#8217;t have to be about
technologies, it can be about any competencies that you want analyse.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Changing Test Gears]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/07/09/changing-test-gears/"/>
    <updated>2010-07-09T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/07/09/changing-test-gears</id>
    <content type="html"><![CDATA[<p>Good poker players know when to change gears. They know when to alter their playing style from cautious to aggressive as the game changes and players drop out. They look at how the <em>odds change</em> as the game progresses and react appropriately. It&#8217;s the same with testing, you gotta know when to change gears.</p>

<p>To put it development terms, good developers know when to change gears. They
know when to change their testing style from cautious to aggressive as the
code evolves.</p>

<p>Lets pretend there is just three types of testing; unit, integration and
acceptance. In the interest of stereotyping, we&#8217;ll define them simplistically
as</p>

<ul>
<li><em>Unit</em> - single object tests, no collaborations (strict I know, but bear with me)</li>
<li><em>Integration</em> - testing object collaborations, for the purposes of this article, lets assume end-to-end testing slot into this bracket</li>
<li><em>Acceptance</em> - leaning towards end-to-end but key here is that they are customer authored. As such, to convince the customer these will likely be relatively coarse grained and start outside the system boundary</li>
</ul>


<!-- more -->


<h3>Starting in a low gear with unit tests</h3>

<p>People are probably most comfortable with this type of testing. The term unit
testing and the technology JUnit have become so intertwined in the Java world,
that people often confuse tests written with JUnit as unit tests. They may be,
but they may not be. So where&#8217;s the value in defining the term unit testing
and how does knowing what type of test you&#8217;ve just written in JUnit help with
changing gears?</p>

<p>Knowing what gear you&#8217;re in and knowing the terrain that’s coming up is
essential for you to select the right gear. Writing a non-unit test in JUnit
has value, of course it does (assuming it actually tests something) so why
should I care if it’s a unit test or a chazzwazzer? Knowing where you are and
where you want to be is useful because you can defer some things and avoid
duplication. So for me, unit testing is good for testing the edge cases (Right
BICEP) and exploring the class you&#8217;re writing. It can be especially useful
when you <em>test drive</em> towards something or explore relationships and your
understanding of the classes roles and responsibilities. In this sense,
testing becomes a design activity or an analysis activity, a chance to phrase
your thinking and understanding in code. The regression element can quickly
lose value here. For example, writing a test with mocks to explore the
interaction between two collaborators, A and B. Then writing a separate test
to explore the same for classes B and C. Then a test for A, B and C. There was
value in each test individually, but is there still value in all three when
there is obvious cross-over? When might I consciously choose <em>not</em> to write
unit tests?</p>

<h3>Changing up to integration tests</h3>

<p>If I know the context that a set of objects are going to work together in, I&#8217;m
going to want to be confident that they work together as expected. I can&#8217;t
test these in isolation, so I&#8217;m going to need to test them in cooperation. At
this level, my confidence is fairly high around the composites so I&#8217;m already
up and running, I&#8217;m more concerned here with a broader brush approach. I&#8217;m
certainly not interested in re-testing all the lower level object tests, just
how they operate together. So I change up a gear and as a developer, convince
myself that these object work together <em>in context</em>. I&#8217;m most likely still
using JUnit but I understand what gear I&#8217;m in.</p>

<h3>Cruising with acceptance tests</h3>

<p>So how about the value to the business? The unit tests in particular don&#8217;t
advertise value to the business, they&#8217;re a developer tool and its all too easy
to write individual classes well with good test coverage and yet combine them
into something that doesn&#8217;t work. Demonstrating to business that their
specifications have been meet is the ultimate gear, and to change up to that
gear and have overall confidence in the system means going through the
previous gears to get there. Knowing that you&#8217;ll be changing up whilst in
lower gears can help you decide what to do in those lower gears.</p>

<p>For example, lets assume the business want to <em>see</em> the affect of a
configuration file in the system. When developing the code to load and decode
the contents of the file, you started by proving the component works at the
unit level so why would you test that the component is wired up correctly as a
unit test? You&#8217;d be forced to mock that component in some higher level
component and test it calls it. But what does this give you? You can still
wire the higher level component up incorrectly. The acceptance test is going
to have to test this to demonstrate the affect, so there&#8217;s an argument to say
you can leave it to the acceptance test to verify. This might have the added
bonus of avoiding &#8220;breaking up&#8221; the higher level component albeit a minor
point.</p>

<h3>The missing gear?</h3>

<p>When we build software in a componentised way, we&#8217;re often left with objects
that work in isolation with their dependencies passed in. We push up and up
the assembly of the objects and their ultimate iterations and are left with
parts of the system that are responsible for this assembly. This might be
done in code or by some dependency injection framework. Either way,
it feels like these &#8216;assemblers&#8217; have a clear role
and responsibility and so shouldn&#8217;t they be tested? What gear do we test them
in? Personally, I&#8217;m comfortable in limiting the assembly options and so reduce
the combinations of testing required. With a single &#8220;builder&#8221; or &#8220;spring
context&#8221;, I&#8217;m comfortable with testing these through acceptance tests.</p>

<p>In this article, I suppose I&#8217;m using &#8220;gears&#8221; as an analogy for pragmatism and
certainly not pace. I&#8217;m not saying that good developers know when to rush,
compromising quality but they do know how to optimise their testing
strategies. I think its important not to get bogged down in exhaustive unit-
style testing if its not of value and so understanding what gear you&#8217;re in and
what gear you&#8217;ll soon be in can help focus your attentions. What to test and
when is the question I find myself asking again and again.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Generate Concordion Overviews]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/07/07/generate-concordion-overviews/"/>
    <updated>2010-07-07T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/07/07/generate-concordion-overviews</id>
    <content type="html"><![CDATA[<p>Creating customer authored acceptance tests is awesome! I love it. Getting your users to tell you exactly what they want (and don&#8217;t want) in a form that they can (ghost) write can make for a world that even the Care Bears are jealous of.</p>

<p>I can&#8217;t comment on some of the BDD targeting frameworks like
<a href="http://jbehave.org/">JBehave</a>, <a href="http://www.easyb.org/">EasyB</a> or
<a href="http://cukes.info/">Cucumber</a> but I do like using
<a href="http://www.concordion.org/">Concordion</a>. We try and use it in such as way to
fit in with a BDD approach, its flexible enough to use in almost any approach
in fact. That&#8217;s probably why I like it so much. It&#8217;s frequently cited closest
comparator is probably Fit but that&#8217;s a little unfair. As I say, Concordion
tries really hard not to tie you into a particular approach, so to compare it
against Fit (which leans towards the inflexible in my view), doesn&#8217;t serve as
a fair comparison.</p>

<p>Anyway, the point to this post isn&#8217;t really to comment on Concordion but to
advertise a little Ant task I wrote to help auto-generate Concordion-friendly
summary pages for your existing Concordion tests.</p>

<!-- more -->


<p>It&#8217;s purpose is to collect your Concordion tests as an &#8220;overview page&#8221; which
itself is a Concordion specification. You&#8217;d run just this specification and it
would in turn run all your tests, giving you a nice red / green overview. You
can fold it into your continuous itegration process (Ant or Maven) and publish
the overview and related specifications straight to some HTTP server for your
customers to review, per-build, 24/7. Nice.</p>

<p>Check out the <a href="http://badrobot.googlecode.com/svn/trunk/bad.robot/concordion-ant-task/manual/Overview.html">user manual</a>, written as Concordion
specifications and download the binaries from <a href="http://code.google.com/p/badrobot/downloads/list">Google Code</a>.</p>

<p><a href="http://code.google.com/p/badrobot/wiki/ConcordionAntTask"></a></p>

<p><a href="http://4.bp.blogspot.com/_-uMxV_fCbC4/TDTpijCjrxI/AAAAAAAAEoA/ZYmfILds2MY/s1600/concordion.png"><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/TDTpijCjrxI/AAAAAAAAEoA/ZYmfILds2MY/s640/concordion.png"></a></p>

<p>As a closing note, as I mentioned Concordion, its only fair to mention
<a href="http://code.google.com/p/xcordion/">Xcordion</a> (and more recently Xcordion2)
which is essentially a fork of Concordion. The main difference being a
philosophical one. If Concordion constrains some activities within the
specification (mostly to encourage certain principles), Xcordion is more of a
free for all. With great power comes great responsibility and all that. Whilst
Xcordion2 is being worked on, be prepared to build from source. You&#8217;ll notice
a couple of features missing, at least in the short term.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Objectives]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/06/17/objectives/"/>
    <updated>2010-06-17T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/06/17/objectives</id>
    <content type="html"><![CDATA[<p>It&#8217;s objective setting time for the guys at work. Aligning what&#8217;s really good for you with what&#8217;s good for the company shouldn&#8217;t be difficult, right? Your generally heading in the same direction and have similar interests at heart. Why then do we end up with generic meaningless objectives like &#8220;attend a XXX course&#8221;? I think you can get the most out of the objective setting exercise by thinking about what you want <em>personally</em> out of your career, don&#8217;t settle for the bland, phrase your objectives so there is real value in them. So, if the company think of them in terms of</p>

<blockquote><p>S.M.A.R.T</p></blockquote>

<p>I like the think of them as</p>

<blockquote><p>S.M.A.R.T.Y</p></blockquote>

<p>Where the Y is all about <em>YOU</em>; make it personal.</p>

<!-- more -->


<p>For example, we all want to be better developers but how do you phrase that as
an acceptable business objective that management can neatly label it, put in a
box and pull out in twelve months time to see if it&#8217;s flourished? Defining
&#8220;better&#8221; in terms of SMART isn&#8217;t going to be easy. How about rephrasing it and
thinking about it as reflecting on your coding practice? Keep a code journal
of good and bad coding choices, yours and your teams. Reflect on it regularly
and update entries. Was choosing a ThreadsafeDooDar here the right decision
three months on, did it ever get used in a threaded context? How about that
choice of using setter over constructor injection? How&#8217;s that working out for
you? The responsibility to reflect is yours but you can get outside
perspectives from your peers.</p>

<p><span class='pullquote-right' data-pullquote='The key personal objective here is to keep learning, the company objective is to become a better developer '>
The key personal objective here is to keep learning, the company objective is to become a better developer. It can be <em>specific</em> because your wording will
reflect something along the lines of &#8220;demonstrate a self-assessment of
personal and the team coding standard and style&#8221;. It&#8217;s hard to avoid the word
&#8220;quality&#8221; but if you do mention it, you should define it (not easy). The point
is there&#8217;s something the company can buy into but there&#8217;s something more
subtle that you can really buy into and get value from. It&#8217;s all about YOU
after all.</p>

<p></span></p>

<p>It&#8217;s measurable (at least from the companies perspective, and so can get
signed off on) because you have your journal as evidence along with dates and
conclusions. You can even emphasize a few key learning points / techniques
that you&#8217;ve changed your opinion on. Change is good and demonstrates learning.</p>

<p>You might be able to extend this by talking in terms of coaching. I poo poo&#8217;ed
a XXX training course earlier because I feel corporate training camps are the
worst place to learn anything (well, there are probably worse places but
there&#8217;s certainly plenty of better environments). Anyway, asking for
professional and formal coaching is a great way to develop and the journal
idea can be used as evidence. The coach can co-author to give it that
&#8220;official stamp&#8221;.</p>

<p>An example journal template might include date, initial description (the
approach you took), pros/cons of the initial decision (why you took the
approach), updated thoughts (including what caused you to reflect on this
specific entry), updated pros/cons, conclusion, peer comments. Try and keep an
entry specific to a single decision you made in the code (coarse or fine
grained). Getting a feel about what to journal and what not to journal should
be pretty natural, any &#8220;niggles&#8221; you get might prompt you or spotting that
you&#8217;re all talking about this part of the code a lot might be a clue.</p>

<p>The real benefit though is what you can take away from it, if you talk over
your journal points with the team and keep an open mind, I&#8217;d hope it gets
filled with lots of nuggets you can add to your toolbox.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Un/Marshalling]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/05/01/unmarshalling/"/>
    <updated>2010-05-01T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/05/01/unmarshalling</id>
    <content type="html"><![CDATA[<p>This post should probably be titled &#8220;Why I don&#8217;t like Unmarhsalling frameworks&#8221;. They just hack me off. I mean really,
who wants to have to use the Java objects that they make you use? It&#8217;s not that they don&#8217;t represent as objects the data that the frameworks unmarshall, they do. It&#8217;s more that the underlying data may or may not match your systems view of the domain. I don&#8217;t want to have to run some process to generate <code>Foo.java</code> only to convert it to <code>MyFoo.java</code>, I&#8217;d rather go straight to <code>MyFoo</code>.</p>

<p>I was using Castor to do the former some time ago. It sounded like a good
idea, and I got going really quickly. However, I quickly didn&#8217;t like the
objects its produced so had to modify the <code>mapping.xml</code> to &#8220;tailor&#8221; the
marshalling. Still fine, this was ok for a while but soon enough I descended
into Castor mapping hell. I seriously spent days trying to tweak things and
had to compromise the model in the end.</p>

<p>After reflection, I thought I&#8217;d try and dump Castor. I replaced the
marshalling with merging to a template and produced cleaner XML in under an
hour. The unmarshalling, replaced with manually parsing the XML and inserting
elements directly into objects. I couldn&#8217;t believe how much less pain I was
feeling!</p>

<p>For me, the overhead of maintaining these more &#8220;manual&#8221; approaches is far less
than working around any framework mismatches. If you&#8217;re lucky enough to find
an marhsalling framework that can grow with you, fair play, but I&#8217;m heavily
biased towards a more manual approach these days. Down with [insert your
framework here].</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setter vs Constructor Injection]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/05/01/setter-vs-constructor-injection/"/>
    <updated>2010-05-01T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/05/01/setter-vs-constructor-injection</id>
    <content type="html"><![CDATA[<p>So what is the argument for / against? It can be a tough one to describe as I recently discovered.</p>

<p>You can say that constructor injection forces an object to have its
dependencies set explicitly and setter injection is open to forgetfulness but
how powerful an argument is that really? Surely the tests would catch it if
you miss a set call? Constructor injection does say upfront &#8220;this is what I
need&#8221;, so there&#8217;s no &#8220;first call this, then this and don&#8217;t forget this&#8221; - its
explicit and you don&#8217;t need to know the internals that setters try and expose.
That&#8217;s useful. But on the small, how complex do the combination of set calls
get?</p>

<p>I don&#8217;t think that a large number of constructor arguments justifies defecting
to the setter camp as the real smell here is often that the class is doing too
much and/or has too many dependencies. It&#8217;s often cited that the reason
there are lots of setters is because of particular dependency injection
framework leads you in that direction but why compromise (I should probably
say, <em>comply</em>) because you&#8217;re <em>told</em> to?</p>

<p>How about the way the system would grow using constructors vs setters? I think
this is where the real argument lies. You can move forward perfectly happily
with either approach, content with the fact that dependencies are isolated.
Testing becomes simpler, more focused on the objects under test and the earth
continues to orbit the sun. Its only much later when the system is all but
grown up that you can look back and reflect. Have setters contributed to
creating a system that is assembled in a complex, disheveled way? Are you
leaning on external (ahem, xml) configuration to manage this? Alternatively,
has a constructor centric approach left you with a system with a more concise
declarative assembly strategy? Which has more noise? You tell me&#8230;</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Wrapping Exceptions is Dull]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/04/25/wrapping-exceptions-is-dull/"/>
    <updated>2010-04-25T00:00:00+01:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/04/25/wrapping-exceptions-is-dull</id>
    <content type="html"><![CDATA[<p>I&#8217;m totally bored of wrapping exceptions in Java,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// do something</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BoredomException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="c1">// do something else</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s verbose, ugly and has nothing to do with what you&#8217;re really trying to
convey. It&#8217;s just noise (more or less). For example, when using the just
<em>dreadful</em> Google Data API to access my calendar, I wrapped a couple of
underlying Google services to be able to mock. Each service wanted to throw a
bunch of Google specific exceptions which I, of course, wanted to rethrow as
application specific. Boring&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">O</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CalendarException</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>  <span class="c1">// the call to the google service</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MalformedURLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CalendarException</span><span class="o">(</span><span class="n">BAD_URL_MESSAGE</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CalendarException</span><span class="o">(</span><span class="n">IO_EXCEPTION_MESSAGE</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">AuthenticationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CalendarException</span><span class="o">(</span><span class="n">AUTHENTICATION_MESSAGE</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CalendarException</span><span class="o">(</span><span class="n">SERVICE_EXCEPTION_MESSAGE</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If I didn&#8217;t delegate like this, every service call would have to wrap and
handle the google exceptions. As I&#8217;ve done this a few times, I decided to add
it to <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a> as a
<code>ExceptionWrapper</code> class. Using this class, you can wrap a <code>Callable</code> to
rethrow any caught exception as some other (including the underlying exception
as the <code>cause</code>).</p>

<p>So, in a similar way to the above, the client can ignore any declared
exceptions and just rethrow them in-line. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">wrapAnyException</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ServiceException</span> <span class="o">{</span>
</span><span class='line'>         <span class="c1">// nasty code throwing a bunch of exceptions</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">},</span> <span class="n">with</span><span class="o">(</span><span class="n">CalendarException</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>when this is in-lined further, it hopefully becomes more succinct.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">wrapAnyException</span><span class="o">(</span><span class="n">serviceCall</span><span class="o">(),</span> <span class="n">with</span><span class="o">(</span><span class="n">CalendarException</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will wrap any exception and rethrow as a new <code>CalendarException</code> to
include as the cause any underlying exception. It uses reflection to create
the new exception, and forces the syntactically sugary <code>with</code> by taking a
<code>WithException</code> as the second parameter.</p>

<p>It&#8217;s a candidate feature for tempus-fugit 1.1 for now, and will go in for sure
if it gets some millage. Let me know if you find it useful. Source is
<a href="http://code.google.com/p/tempus-fugit/source/browse/trunk/tempus-fugit/src/main/java/com/google/code/tempusfugit/ExceptionWrapper.java">here</a> with
the test <a href="http://code.google.com/p/tempus-fugit/source/browse/trunk/tempus-fugit/src/test/java/com/google/code/tempusfugit/ExceptionWrapperTest.java">here</a>.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nibbles the Cat]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/03/19/nibbles-cat/"/>
    <updated>2010-03-19T00:00:00+00:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/03/19/nibbles-cat</id>
    <content type="html"><![CDATA[<p>What has Nibbles the Cat got to do with deadlocks? I&#8217;m glad you asked. It all started when I introduced a deadlock in some performance monitoring. I inadvertently prevented a statistic collection daemon I wrote from shutting down thanks to some unlucky timing and bad synchronisation policy. Because the synchronisation that was involved was distributed across a couple of classes (including some external classes) it wasn&#8217;t obvious where they clashed. It got me thinking more about deadlocks and how many times we <em>actually </em>see them in real systems and gave rise to me creating the DeadlockDetector class in tempus-fugit.</p>

<p>I&#8217;m talking here about Java level deadlocks really and to illustrate the
point, poor old <code>Nibbles</code> got himself in quite a pickle. This situation is like
this; <code>Nibbles</code> has been abducted and the  <code>Kidnapper</code> and <code>Negotiator</code> have started
a dialogue&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">potentialDeadlock</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>     <span class="k">new</span> <span class="nf">Kidnapper</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>     <span class="k">new</span> <span class="nf">Negotiator</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, in the process of negotiation it becomes apparent that the  <code>Kidnapper</code>
is unwilling to release poor <code>Nibbles</code> until he has received the <code>Cash</code> and the
<code>Negotiator</code> is unwilling to part with the <code>Cash</code> until he has poor <code>Nibbles</code> back
in his arms.</p>

<!-- more -->


<p>By synchronising on nibbles below, the  <code>Kidnapper</code> is holding onto him (more
specifically his monitor) until the end of the synchronised block. However,
within this block the  <code>Kidnapper</code> is trying
to take the cash. The access to this method is itself synchronised on the
cash, meaning that no one else can access the cash whilst
the  <code>Kidnapper</code> is grabbing it. Meanwhile,
the <code>Negotiator</code> is synchronising on the
cash, holding onto it (or again, more specifically, it&#8217;s monitor) until the
end of the synchronised block then within that block, it requires nibbles. We
can start to see the potential for deadlock.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Kidnapper</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">nibbles</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="kd">synchronized</span> <span class="o">(</span><span class="n">cash</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">take</span><span class="o">(</span><span class="n">cash</span><span class="o">);</span>
</span><span class='line'>         <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Negotiator</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">cash</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="kd">synchronized</span> <span class="o">(</span><span class="n">nibbles</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">take</span><span class="o">(</span><span class="n">nibbles</span><span class="o">);</span>
</span><span class='line'>         <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The deadlock detector displays this woeful situation as follows.</p>

<pre><code>Deadlock detected
=================

"Negotiator-Thread-1":
  waiting to lock Monitor of com.google.code.tempusfugit.concurrency.DeadlockDetectorTest$Cat@ce4a8a
  which is held by "Kidnapper-Thread-0"

"Kidnapper-Thread-0":
  waiting to lock Monitor of com.google.code.tempusfugit.concurrency.DeadlockDetectorTest$Cash@7fc8b2
  which is held by "Negotiator-Thread-1"
</code></pre>

<p>If you fire up the example and point jconsole at it, you&#8217;ll get similar
results from the Thread tab. You can see how tempus-fugit tests the
DeadlockDetector class <a href="http://tempus-fugit.googlecode.com/svn/site/documentation/xref-test/com/google/code/tempusfugit/concurrency/DeadlockDetectorTest.html">here</a> and to
find out more about see the project <a href="http://tempus-fugit.googlecode.com/svn/site/documentation/concurrency.html#Deadlock_Detection">documentation</a>.</p>

<p>oh and don&#8217;t worry, <code>Nibbles</code> was released and the  <code>Kidnapper</code> arrested in the
end.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Type Safe Annotation]]></title>
    <link href="http://www.baddotrobot.com/blog/2010/01/04/type-safe-annotation/"/>
    <updated>2010-01-04T00:00:00+00:00</updated>
    <id>http://www.baddotrobot.com/blog/2010/01/04/type-safe-annotation</id>
    <content type="html"><![CDATA[<p>A new year and another Java gripe! This time its annotations and the lack of anything useful by way of parameters. Implementing the Goetz annotations from <a href="http://www.amazon.co.uk/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601?ie=UTF8&amp;tag=diyfiesta&amp;link_code=btl&amp;camp=213689&amp;creative=392969">Concurrency In Practice</a>, I wanted to include an enum as a parameter type. Kind of like this</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">GuardedBy</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Type</span> <span class="nf">value</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="kd">public</span> <span class="kd">enum</span> <span class="n">Type</span> <span class="o">{</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">CLASS</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So far so good. I then wanted to somehow parameterise the enum constants themselves to give extra information.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">GuardedBy</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Type</span> <span class="nf">value</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="kd">public</span> <span class="kd">enum</span> <span class="n">Type</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">CLASS</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">public</span> <span class="kd">static</span> <span class="n">Type</span> <span class="nf">FIELD</span><span class="o">(</span><span class="n">String</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">FIELD</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">public</span> <span class="kd">static</span> <span class="n">Type</span> <span class="nf">CLASS</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">CLASS</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, here&#8217;s where the trouble began.</p>

<!-- more -->


<p>Using the static constructor method is
fine when I want to create an instance of a Type but not when I want to
annotate some method. For example,</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@GuardedBy</span><span class="o">(</span><span class="n">GuardedBy</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">CLASS</span><span class="o">(</span><span class="s">&quot;more info&quot;</span><span class="o">))</span> <span class="c1">// javac cries</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">GuardedBy</span><span class="o">.</span><span class="na">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">GuardedBy</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">CLASS</span><span class="o">(</span><span class="s">&quot;more info&quot;</span><span class="o">);</span> <span class="c1">// fine</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The compiler very quickly complains that the attribute value must be constant.
Specifically,</p>

<pre><code>an enum annotation value must be an enum constant
</code></pre>

<p>To get round things, you can just create several attributes for the
annotation. Rather than have a nice <code>CLASS</code> type which can optionally have a
description, I was forced to have one attribute of type and another to capture
the additional information. grrrr.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">GuardedBy</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Type</span> <span class="nf">value</span><span class="o">();</span>
</span><span class='line'>   <span class="n">String</span> <span class="nf">details</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="kd">public</span> <span class="kd">enum</span> <span class="n">Type</span> <span class="o">{</span> <span class="n">CLASS</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Shame on you Java for leading me on a merry dance! I&#8217;d love to know more about
why things are like this, so if you&#8217;ve got any more details, feel free to post
a comment.</p>

<p><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png"></p>
]]></content>
  </entry>
  
</feed>
