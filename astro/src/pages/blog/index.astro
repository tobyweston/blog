---
import {getCollection} from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import SiteLayout from '../../components/ui/SiteLayout.astro';
import PostCard from '../../components/ui/PostCard.astro';

const posts = (await getCollection('blog')) as CollectionEntry<'blog'>[];
posts.sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const perPage = 12;
const pagePosts = posts.slice(0, perPage);
---

<SiteLayout title="Blog - bad.robot" description="Recent blog posts">
  <section>
    <h1 class="text-3xl font-bold mb-6">Blog</h1>
    <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {pagePosts.map((p: CollectionEntry<'blog'>) => (
        <PostCard post={p} />
      ))}
    </div>

    {posts.length > perPage && (
      <div id="loading-indicator" class="mt-8 text-center hidden">
        <div class="inline-flex items-center px-4 py-2 text-gray-600">
          <div class="bouncing-loader mr-3">
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div>
      </div>
    )}

    <div id="scroll-sentinel" class="h-4"></div>
  </section>

  <style>
    .bouncing-loader {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .bouncing-loader > div {
      width: 0.75rem;
      height: 0.75rem;
      background-color: var(--accent, #2337ff);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .bouncing-loader > div:nth-child(1) {
      animation-delay: -0.32s;
    }

    .bouncing-loader > div:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>

  <script type="module" define:vars={{perPage, totalPosts: posts.length}}>
    let offset = perPage;
    let loading = false;
    let hasMore = totalPosts > perPage;

    const postsGrid = document.getElementById('posts-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const sentinel = document.getElementById('scroll-sentinel');

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function createPostCard(post) {
      const article = document.createElement('article');
      article.className = 'card hover:shadow-medium';

      const link = document.createElement('a');
      link.href = `/blog/${post.slug}/`;
      link.className = 'block no-underline';

      const title = document.createElement('h3');
      title.className = 'text-xl font-bold mb-2 text-gray-900';
      title.textContent = post.title;

      const dateDiv = document.createElement('div');
      dateDiv.className = 'text-sm text-gray-500 mb-3 font-medium';
      dateDiv.textContent = formatDate(post.pubDate);

      const description = document.createElement('p');
      description.className = 'text-gray-700 line-clamp-3';
      description.textContent = post.description || '';

      link.appendChild(title);
      link.appendChild(dateDiv);
      link.appendChild(description);
      article.appendChild(link);

      return article;
    }

    async function loadMorePosts() {
      console.log('loadMorePosts called', { loading, hasMore, offset });
      if (loading || !hasMore) return;

      loading = true;
      loadingIndicator?.classList.remove('hidden');
      console.log('Loading indicator shown, fetching posts...');

      // Track when loading started for minimum display time
      const loadStartTime = Date.now();
      const minDisplayTime = 1000; // 1 seconds minimum

      try {
        const response = await fetch(`/api/posts.json?offset=${offset}&limit=12`);
        const data = await response.json();
        console.log('Fetched data:', data);

        // Calculate how long to wait before showing results
        const elapsedTime = Date.now() - loadStartTime;
        const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
        console.log(`Waiting ${remainingTime}ms before showing posts`);

        // Wait for the remaining time before adding posts
        setTimeout(() => {
          console.log('Adding posts to grid');
          data.posts.forEach(post => {
            const card = createPostCard(post);
            postsGrid?.appendChild(card);
          });

          offset = data.nextOffset;
          hasMore = data.hasMore;
          console.log('Updated state:', { offset, hasMore });

          if (!hasMore && sentinel) {
            sentinel.style.display = 'none';
            console.log('No more posts, hiding sentinel');
          }

          loading = false;
          loadingIndicator?.classList.add('hidden');
          console.log('Loading complete, indicator hidden');
        }, remainingTime);

      } catch (error) {
        console.error('Failed to load more posts:', error);

        // Still respect minimum display time on error
        const elapsedTime = Date.now() - loadStartTime;
        const remainingTime = Math.max(0, minDisplayTime - elapsedTime);

        setTimeout(() => {
          loading = false;
          loadingIndicator?.classList.add('hidden');
        }, remainingTime);
      }
    }

    // Intersection Observer for infinite scroll
    if (sentinel && hasMore) {
      console.log('Setting up Intersection Observer', { sentinel, hasMore });
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log('Intersection event:', { isIntersecting: entry.isIntersecting, loading, hasMore });
            if (entry.isIntersecting) {
              loadMorePosts();
            }
          });
        },
        {
          rootMargin: '200px', // Start loading 200px before reaching the sentinel
        }
      );

      observer.observe(sentinel);
      console.log('Observer attached to sentinel');
    } else {
      console.log('Sentinel or hasMore not available', { sentinel, hasMore });
    }
  </script>
</SiteLayout>
