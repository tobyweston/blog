---
import {getCollection} from 'astro:content';
import SiteLayout from '../../components/ui/SiteLayout.astro';

// Fetch posts (avoid using generic type syntax in frontmatter which can be parsed as JSX)
const posts = (await getCollection('blog')).sort((a,b)=> b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
// Replace Object.groupBy (not available in some Node versions) with a compatible reduce-based helper
const byYear = posts.reduce((acc, p) => {
  const year = String(p.data.pubDate.getFullYear());
  if (!acc[year]) acc[year] = [];
  acc[year].push(p);
  return acc;
}, {});
---

<SiteLayout title="Archive - bad.robot" description="All posts">
  <section>
    <h1 class="text-3xl font-bold mb-4">Archive</h1>
    <div class="mb-6">
      <input id="search" placeholder="Search posts by title..." class="w-full border rounded px-3 py-2" />
    </div>

    <div id="posts">
      {Object.keys(byYear).sort((a,b)=>Number(b)-Number(a)).map(year => (
        <div class="mb-8">
          <h2 class="text-xl font-semibold mb-3">{year}</h2>
          <ul class="list-disc pl-6 space-y-2">
            {(byYear[year] || []).map(p => (
              <li data-title={p.data.title.toLowerCase()}>
                <a href={`/blog/${p.slug}/`} class="text-slate-800 hover:text-sky-600">{p.data.title}</a>
                <div class="text-sm text-slate-500">{p.data.pubDate.toDateString()}</div>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  </section>

  <script type="module">
    const input = document.getElementById('search');
    const posts = Array.from(document.querySelectorAll('#posts li'));
    input.addEventListener('input', (e) => {
      const q = e.target.value.trim().toLowerCase();
      posts.forEach(li => {
        const t = li.dataset.title || '';
        li.style.display = t.includes(q) ? '' : 'none';
      });
    });
  </script>
</SiteLayout>
