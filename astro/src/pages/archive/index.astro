---
import {getCollection} from 'astro:content';
import SiteLayout from '../../components/ui/SiteLayout.astro';

const blogPosts = (await getCollection('blog')).map(p => ({ ...p, type: 'blog' as const }));
const videos    = (await getCollection('video')).map(v => ({ ...v, type: 'video' as const }));

const allItems = [...blogPosts, ...videos]
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

type ItemsByYear = Record<string, typeof allItems>;
const byYear = allItems.reduce((acc: ItemsByYear, p) => {
  const year = String(p.data.pubDate.getFullYear());
  if (!acc[year]) acc[year] = [];
  acc[year].push(p);
  return acc;
}, {} as ItemsByYear);
---

<SiteLayout title="Archive - bad.robot" description="All posts">
  <section>
    <h1 class="page-kicker mb-8">Archive</h1>
    <div class="mb-8">
      <label for="search" class="sr-only">Search posts by title or subtitle</label>
      <div class="relative w-full">
        <input id="search" placeholder="Search posts by title..." class="w-full px-4 py-3 pl-12 pr-4 text-base bg-white border-2 border-slate-200 rounded-xl focus:outline-none focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 placeholder-slate-400 shadow-sm hover:border-slate-300" />
      </div>
    </div>

    <div id="posts">
      {Object.keys(byYear).sort((a,b)=>Number(b)-Number(a)).map(year => (
        <div class="mb-8" data-year-group>
          <h2 class="text-xl font-semibold mb-3">{year}</h2>
          <ul class="list-disc pl-6 space-y-2">
            {(byYear[year] || []).map((p: typeof allItems[0]) => (
              <li data-title={p.data.title.toLowerCase()} data-subtitle={(p.data as any).subTitle?.toLowerCase() || ''}>
                <div class="flex flex-wrap items-baseline gap-2">
                  <a href={p.type === 'video' ? `/video/${p.slug}/` : `/blog/${p.slug}/`} class="text-slate-800 hover:text-sky-600">{p.data.title}</a>
                  {(p.data as any).subTitle && <span class="text-sm text-slate-500 italic">{(p.data as any).subTitle}</span>}
                  {p.type === 'video' && <span class="archive-badge archive-badge--video">video</span>}
                </div>
                <div class="text-sm text-slate-500">{p.data.pubDate.toDateString()}</div>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  </section>

  <style>
    .archive-badge {
      display: inline-block;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      vertical-align: middle;
    }
    .archive-badge--video {
      background: var(--accent);
      color: #fff;
    }
  </style>

  <script type="module" is:inline>
    const input = document.getElementById('search');
    const posts = Array.from(document.querySelectorAll('#posts li'));
    const yearGroups = Array.from(document.querySelectorAll('#posts [data-year-group]')).map(group => ({
      el: group,
      items: Array.from(group.querySelectorAll('li')),
    }));
    input.addEventListener('input', (e) => {
      const q = e.target.value.trim().toLowerCase();
      posts.forEach(li => {
        const title = li.dataset.title || '';
        const subtitle = li.dataset.subtitle || '';
        const matches = title.includes(q) || subtitle.includes(q);
        li.style.display = matches ? '' : 'none';
      });
      yearGroups.forEach(({ el, items }) => {
        const anyVisible = items.some(li => li.style.display !== 'none');
        el.style.display = anyVisible ? '' : 'none';
      });
    });
  </script>
</SiteLayout>
