--- 
name: atomiticy-of-thread-class
layout: post
title: Atomiticy of the Thread class
time: 2009-12-10 09:18:00 +00:00
---
I had an interesting time getting a couple of tests running for <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a> recently. It threw up a couple of interesting aspects about using threads that I hadn't come across before.<br /><br />In one particular test, I wanted to show that <span style="font-size:85%;"><span style="font-family:courier new;">interrupt</span></span> is called on a thread and so followed what's becoming a common pattern for me.<br /><pre name="code" class="java:nogutter:nocontrols">@Test<br />public void sleepInterrupted() throws Exception {<br />   Thread thread = threadSleepsForever();<br />   thread.start();<br />   waitForStartup(thread);<br />   thread.interrupt();<br />   waitForShutdown(thread);<br />   assertThat(thread.isInterrupted(), is(true));<br />}<br /></pre>The alternative patten is to wait for the assertion and avoid the wait for shutdown method above. Either way, the test above is testing the the thread created has been interrupted by checking the interrupt flag.<br /><br />The test was failing for me even though I was able to show that the interrupt is called and the interrupt flag is set immediately after the sleeping thread is woken. However, when the test reached the assert, it was false. Weird.<br /><br />I setup another thread to just poll the sleeping thread for its status and it showed the following.<br /><br /><pre>thread.isInterrupted() = false, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() = TIMED_WAITING<br />thread.isInterrupted() = true, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() TERMINATED<br /></pre>So my thread <span style="font-weight: bold; font-style: italic;">was</span> interrupted! It seems to say that when a thread terminates, it will reset the interrupt status flag. Looking at the source, it looks like Java maintains the flag at the native level and not as a member of the <span style="font-size:85%;"><span style="font-family:courier new;">Thread</span></span> class.<br /><br /><pre>private native void interrupt0();</pre>Looking at another run, I got the following<br /><br /><pre>thread.isInterrupted() = false, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() = RUNNABLE<br />thread.isInterrupted() = false, thread.getState() = TIMED_WAITING<br />thread.isInterrupted() = true, thread.getState() = TIMED_WAITING<br />thread.isInterrupted() = false, thread.getState() = TERMINATED<br /></pre>This is even more interesting as it would suggest that an <span style="font-size:85%;"><span style="font-family:courier new;">interrupt</span></span> doesn't update the thread's state and the interrupt flag atomically.<br /><br /><div style="text-align: center;"><blockquote>It would seem thread termination will reset the interrupt status flag and that an interrupt doesn't update the interrupt status flag and state atomically.</blockquote></div><br /><br />As an couple of caveats to the type of test above where I want to check the interrupt status flag, its a good idea to avoid side affects by using the terribly named method <span style="font-size:85%;"><span style="font-family:courier new;">Thread.interrupted </span></span>rather than <span style="font-size:85%;"><span style="font-family:courier new;">isIntrrupted</span></span>. I also had to use a stubbed thread to reliably tell if the interrupt was called.<br /><br />See the code <a href="http://code.google.com/p/tempus-fugit/source/browse/trunk/tempus-fugit/src/test/java/com/google/code/tempusfugit/concurrency/ThreadUtilsTest.java">here</a>.<br /><br /><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png" alt="" id="BLOGGER_PHOTO_ID_5283328307719135378" style="margin: 0pt 10px 10px 0pt; float: left; cursor: pointer; width: 22px; height: 22px;" border="0" /><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/20485368-3700763889994877521?l=pequenoperro.blogspot.com' alt='' /></div>
