--- 
name: loggin-is-still-evil-but
layout: post
title: Loggin is still evil but...
time: 2011-06-22 21:14:00 +01:00
---
In a <a href="http://pequenoperro.blogspot.com/2010/10/logging-is-evil-but.html">previous post</a>, I was going on about how evil logging is. How it's often confused as a requirement and often badly misused. The upshot of the post was that if you're going to log stuff, in our case using Log4J, lets be honest about it and test it. We should be able to say upfront what's important to log, in what situations and at what log level. Sounds like a straight forward case of test first.<br /><br />Mocking Log4J however can be a real pain. I've managed it in the past using Apache's logging abstraction and configuring it to use Log4J under the covers but in my previous post, I demonstrated a slightly easier way. A helper class called <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Log4J</span> that we can use to represent the logging system and that we can make assertions against. Pretty cool so far.<br /><br /><a name='more'></a><br />There was one caveat, I wasn't entirely happy with the fact that the class would rely on your external Log4J configuration. To assert that a log message appeared at the level INFO for example, you'd have to make sure that the test environment sets up the appropriate class to log at that level. It made for a kind of integration / environmental test which in some cases might be a sensible test but for the most part, I kept seeing test failures down to configuration on different environments. Yuk.<br /><br />So I updated the helper class to include a log level override which will ignore what the actual configuration says. This means you can write less brittle tests to say things like "ensure my log message is output at debug level regardless of the runtime configuration". <br /><br />The updated class looks like this.<br /><br /><pre class="java:nogutter:nocontrols" name="code">public class Log4J {<br /> <br />    private final StringWriter writer = new StringWriter();<br />    private final Logger logger;<br />    private final String uuid = UUID.randomUUID().toString();<br /> <br />    public static Log4J appendTo(Logger logger) {<br />        return new Log4J(logger, ALL);<br />    }<br /> <br />    public static Log4J appendTo(Logger logger, Level level) {<br />        return new Log4J(logger, level);<br />    }<br /> <br />    private Log4J(Logger logger, Level level) {<br />        this.logger = logger;<br />        WriterAppender appender = new WriterAppender(new SimpleLayout(), writer);<br />        appender.setName(uuid);<br />        logger.addAppender(appender);<br />        logger.setLevel(level);<br />    }<br /> <br />    public void clean() {<br />        logger.removeAppender(uuid);<br />    }<br /> <br />    public void assertThat(Matcher&lt;String&gt; matcher) {<br />        org.junit.Assert.assertThat(writer.toString(), matcher);<br />    }<br />}</pre><br />Which means you can setup to expect a log level at say the ERROR level like this.<br /><br /><pre class="java:nogutter:nocontrols" name="code">private final Log4J logger = Log4J.appendTo(Logger.getLogger(Post.class), LogLevel.ERROR);</pre><br />The make assertions like this (which would fail if the matcher fails or because its not logged at the expected level.<br /><br /><pre class="java:nogutter:nocontrols" name="code">logger.assertThat(containsString(EXCEPTION_MESSAGE));<br /></pre><br />I still think logging is evil and try <i>really</i> hard not to use a single log statement but if you have to, I hope the helper class helps keep you honest in your tests ;) Have a look at the <a href="http://pequenoperro.blogspot.com/2010/10/logging-is-evil-but.html">previous post</a> for more details and extended examples.<br /><br /><div><img alt="" border="0" id="BLOGGER_PHOTO_ID_5283328307719135378" src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png" style="cursor: pointer; float: left; height: 22px; margin: 0pt 10px 10px 0pt; width: 22px;" /></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/20485368-7657082122151886527?l=pequenoperro.blogspot.com' alt='' /></div>
