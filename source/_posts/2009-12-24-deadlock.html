--- 
name: deadlock
layout: post
title: Deadlock detection in Java
time: 2009-12-24 15:41:00 +00:00
---
I recently added a basic deadlock detection mechanism to <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a>. The <span style="font-size:85%;"><a style="font-family: courier new;" href="http://code.google.com/p/tempus-fugit/source/browse/trunk/tempus-fugit/src/main/java/com/google/code/tempusfugit/concurrency/DeadlockDetector.java">DeadlockDetector</a></span> class allows you to programmatically detect basic deadlocks in your Java code. You can output deadlocks using the following code (note that printing a thread dump using the <span style=";font-family:courier new;font-size:85%;"  >ThreadDump</span> class will automatically attempt to find any deadlocks).<br /><pre name="code" class="java:nogutter:nocontrols"><br />DeadlockDetector.printDeadlocks(System.out);<br /></pre>The <code>DeadlockDecector</code> class can only spot Java monitor cyclic locking problems. It's implementation                  is basically the same as that used by <code>jconsole</code> and <code>jstack</code> although                  Java 1.6 versions<code></code> can additionally detect <code>Lock</code>                  based cyclic problems. The types of deadlock it can detect can be illustrated in the example below.     <br /><pre name="code" class="java:nogutter:nocontrols">@Test<br />public void potentialDeadlock() {<br />  new Kidnapper().start();<br />  new Negotiator().start();<br />}<br /><br />public class Kidnapper extends Thread {<br />  public void run() {<br />     synchronized (nibbles) {<br />        synchronized (cash) {<br />            take(cash);<br />        }<br />     }<br />  }<br />}<br /><br />public class Negotiator extends Thread {<br />  public void run() {<br />     synchronized (cash) {<br />        synchronized (nibbles) {<br />            take(nibbles);<br />        }<br />     }<br />  }<br />} </pre><br />Here, the <span style="font-size:85%;"><span style="font-family:courier new;">Kidnapper</span></span> is unwilling to release poor Nibbles the <span style="font-size:85%;"><span style="font-family:courier new;">Cat</span></span> until he has the <span style="font-size:85%;"><span style="font-family:courier new;">Cash</span></span> but our <span style="font-size:85%;"><span style="font-family:courier new;">Negotiator</span></span> is unwilling to part with the <span style="font-size:85%;"><span style="font-family:courier new;">Cash</span></span>  until he has poor Nibbles back in his arms. The deadlock detector displays this woeful situation as follows.<br /><pre><br /> Deadlock detected<br /> =================<br /><br /> "Negotiator-Thread-1":<br />    waiting to lock Monitor of ...DeadlockDetectorTest$Cat@ce4a8a<br />    which is held by "Kidnapper-Thread-0"<br /><br /> "Kidnapper-Thread-0":<br />    waiting to lock Monitor of ...DeadlockDetectorTest$Cash@7fc8b2<br />    which is held by "Negotiator-Thread-1"<br /></pre><br />I don't imagine you'll need to print out information about deadlocks or thread dumps from within your code very often, but on the off chance you'll need to during debugging, they are both available for you to use in the <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a> project.<br /><br /><div><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png" alt="" id="BLOGGER_PHOTO_ID_5283328307719135378" style="margin: 0pt 10px 10px 0pt; float: left; cursor: pointer; width: 22px; height: 22px;" border="0" /></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/20485368-6686495597067247223?l=pequenoperro.blogspot.com' alt='' /></div>
