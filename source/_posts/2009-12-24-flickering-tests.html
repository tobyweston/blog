--- 
name: flickering-tests
layout: post
title: Flickering tests and a JUnit Rule
time: 2009-12-24 15:55:00 +00:00
---
Occasionally I'll see pesky flickering tests. Sometimes they're green, sometimes they're red and this can happen without any code changes! Something is afoul for sure. What bugs me the most though is that when trying to fix the problem, I can never be sure that I haven't just been lucky and the green I'm seeing isn't really a false positive. I'll have to manually run the test several times before my confidence grows.<br /><br />In an attempt to ease this heavy burden and make light work of this drudgery, I created an <span style="font-size:85%;"><span style="font-family:courier new;">@Intermittent </span></span>annotation with a corresponding JUnit <span style="font-size:85%;"><span style="font-family:courier new;">Rule</span></span> and <span style="font-size:85%;"><span style="font-family:courier new;">Runner</span></span>. Now, I can mark up a suspect test and get someone else to do the repetition. Joy.<br /><pre name="code" class="java:nogutter:nocontrols"><br />@Test<br />@Intermittent<br />public void flickering() {<br />   // ...<br />}</pre>I can then use the <code>IntermittentRule</code> to run the test method repeatedly.<br /><pre name="code" class="java:nogutter:nocontrols"><br />public class FlickeringTest {<br /><br /> @Rule public IntermittentRule rule = new IntermittentRule();<br /><br /> @Test<br /> @Intermittent<br /> public void flickering() {<br />     // ...<br /> }<br />} </pre>Or  use the <code>@RunWith</code> annotation to run the test using the <code>IntermittentTestRunner</code>.          <br /><pre name="code" class="java:nogutter:nocontrols"><br />@RunWith(IntermittentTestRunner.class)<br />public class FlickeringTest {<br /><br /> @Rule public IntermittentRule rule = new IntermittentRule();<br /><br /> @Test<br /> @Intermittent<br /> public void flickering() {<br />     // ...<br /> }<br />} </pre>What's interesting here is the way in which the <span style="font-size:85%;"><span style="font-family:courier new;">Rule</span></span> and <span style="font-size:85%;"><span style="font-family:courier new;">Runner</span></span> interact with JUnit. Newer versions of JUnit have introduced the idea of <span style="font-size:85%;"><span style="font-family:courier new;">Rule</span></span>s and <span style="font-size:85%;"><span style="font-family:courier new;">Statement</span></span>s. Using a <span style="font-size:85%;"><span style="font-family:courier new;">Rule</span></span> allows access to the underlying <span style="font-size:85%;"><span style="font-family:courier new;">Statement</span></span> which in our case is the action to run the test method. So we're able to run the underlying statement again and again. Nice.<br /><br />The <span style="font-size:85%;"><span style="font-family:courier new;">Runner</span></span> however, can hook into JUnit's framework a different way. It can access more than one statement and so position itself slightly differently. What this means for us is that using the <span style="font-size:85%;"><span style="font-family:courier new;">Rule</span></span> above, any             <code>@Before</code> or <code>@After</code> methods will only be run once but the test method will run multiple times. Using the <span style="font-size:85%;"><span style="font-family:courier new;">Runner</span></span> above however, will run any <code>@Before</code> or <code>@After</code> methods once for each test repetition.<br /><br />The code is available as part of the <a href="http://code.google.com/p/tempus-fugit/">tempus-fugit</a> library so feel free to <a href="http://code.google.com/p/tempus-fugit/source/browse/#svn/trunk/tempus-fugit/src/main/java/com/google/code/tempusfugit/concurrency">browse</a> and feedback your comments.<br /><br /><div><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png" alt="" id="BLOGGER_PHOTO_ID_5283328307719135378" style="margin: 0pt 10px 10px 0pt; float: left; cursor: pointer; width: 22px; height: 22px;" border="0" /></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/20485368-4506272359758878565?l=pequenoperro.blogspot.com' alt='' /></div>
