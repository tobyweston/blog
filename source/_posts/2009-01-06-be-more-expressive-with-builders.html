--- 
name: be-more-expressive-with-builders
layout: post
title: Be more Expressive with Builders
time: 2009-01-06 17:07:00 +00:00
---
I came up with a neat little pattern that's helped me be more expressive in some (fairly specific) situations. Here I'll give you a feel for it using the <span style="font-size:85%;"><span style="font-family:courier new;">CountDownLatch</span></span> class as an example.<br /><br /><h3 style="font-family: courier new;">CountDownLatch.await()</h3>Using an instance of a <span style="font-size:85%;"><span style="font-family:courier new;">CountDownLatch</span></span>, we can wait for the latch to count down to zero, blocking the calling thread before continuing. When using a timeout, the method returns true if the count reached zero or false if the timeout expires. To make the timeout more explicit in my application code, I started with the following.<br /><br /><pre name="code" class="java:nogutter:nocontrols"><br />public void waitForStartup() throws InterruptedException, TimeoutException {<br />  if (!startup.await(5, SECONDS))<br />     throw new TimeoutException();<br />}<br /><br />public void waitForShutdown() throws InterruptedException, TimeoutException {<br />  if (!shutdown.await(5, SECONDS))<br />     throw new TimeoutException();<br />}<br /></pre><br /><br /><h3>Using a Builder with Static Constructor</h3><br />To be more concise, I wanted to wrap the logic above in some kind of helper class. Thanks to lovely static imports, a private constructor and  a static factory method called <span style="font-size:85%;"><span style="font-family:courier new;">await()</span></span>, I was able to express the same thing with the following.<br /><br /><pre name="code" class="java:nogutter:nocontrols"><br />public void waitForStartup() throws InterruptedException, TimeoutException {<br />  await(startup).with(TIMEOUT);<br />}<br /><br />public void waitForShutdown() throws InterruptedException, TimeoutException {<br />  await(shutdown).with(TIMEOUT);<br />}<br /></pre><br /><br />The <span style="font-size:85%;"><span style="font-family:courier new;">with(...)</span></span> method is the thing that actually wraps the call to the<span style="font-size:85%;"><span style="font-family:courier new;"> await()</span></span> method on the latch. I created a <span style="font-size:85%;"><span style="font-family:courier new;">Duration</span></span> class in the above case to capture the timeout constant.<br /><br />This can be a neat little pattern which when used sparingly can lead to little nuggets of really readable code. However, the helper class that employs the static factory can feel unnatural as the method names don't really represent their function but rather their context within the DSL that the class defines. Using a private constructor and verifying the internal state is essential to ensure that the DSL can't be used incorrectly. Basically, if there are very few methods and you make sure they can only be called in a sensible order, I'd suggest its a good pattern to follow. The helper class is shown below in full.<br /><br /><pre name="code" class="java:nogutter:nocontrols"><br />public class CountDownLatchWithTimeout {<br /><br />  private final CountDownLatch latch;<br /><br />  private CountDownLatchWithTimeout(CountDownLatch latch) {<br />     this.latch = latch;<br />  }<br /><br />  public static CountDownLatchWithTimeout await(CountDownLatch latch) {<br />     return new CountDownLatchWithTimeout(latch);<br />  }<br /><br />  public void with(Duration timeout) throws InterruptedException, TimeoutException {<br />     if (!latch.await(timeout.inMillis(), MILLISECONDS))<br />        throw new TimeoutException();<br />  }<br />}<br /></pre><br /><br /><img src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png" style="margin: 0pt 10px 10px 0pt; float: left; cursor: pointer; width: 22px; height: 22px;" alt="" id="BLOGGER_PHOTO_ID_5283328307719135378" border="0" /><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/20485368-8033013171341908355?l=pequenoperro.blogspot.com' alt='' /></div>
