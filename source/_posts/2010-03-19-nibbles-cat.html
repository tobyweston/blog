--- 
name: nibbles-cat
layout: post
title: Nibbles the Cat
time: 2010-03-19 21:39:00 +00:00
---
What has Nibbles the Cat got to do with deadlocks? I'm glad you asked. It all started when I introduced a deadlock in some performance monitoring. I inadvertently prevented a statistic collection daemon I wrote from shutting down thanks to some unlucky timing and bad synchronisation policy. Because the synchronisation that was involved was distributed across a couple of classes (including some external classes) it wasn't obvious where they clashed. It got me thinking more about deadlocks and how many times we <i>actually </i>see them in real systems and gave rise to me creating the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">DeadlockDetector</span></span><span class="Apple-style-span" style="font-size: small;"> </span>class in tempus-fugit.<br /><br />I'm talking here about Java level deadlocks really and to illustrate the point, poor old Nibbles got himself in quite a pickle. This situation is like this; Nibbles has been abducted and the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Kidnapper</span></span><span class="Apple-style-span" style="font-size: small;"> </span>and <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Negotiator</span></span><span class="Apple-style-span" style="font-size: small;"> </span>have started a dialogue...<br /><br /><pre class="java:nogutter:nocontrols" name="code">public void potentialDeadlock() {
<br />     new Kidnapper().start();
<br />     new Negotiator().start();
<br />}
<br /></pre><br />However, in the process of negotiation it becomes apparent that the <span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Kidnapper</span></span> is unwilling to release poor Nibbles until he has received the <span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Cash</span></span> and the <span class="Apple-style-span" style="font-size: small;"><span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;">Negotiator</span></span> is unwilling to part with the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Cash</span></span> until he has poor Nibbles back in his arms.<br /><br />By synchronising on <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">nibbles </span></span>below, the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Kidnapper</span></span> is holding onto him (more specifically his monitor) until the end of the synchronised block. However, within this block the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Kidnapper</span></span><span class="Apple-style-span" style="font-size: small;">&nbsp;</span>is trying to take the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">cash</span></span>. The access to this method is itself synchronised on the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">cash</span></span>, meaning that no one else can access the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">cash</span></span><span class="Apple-style-span" style="font-size: small;"> </span>whilst the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Kidnapper</span></span><span class="Apple-style-span" style="font-size: small;">&nbsp;</span>is grabbing it. Meanwhile, the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Negotiator</span></span><span class="Apple-style-span" style="font-size: small;">&nbsp;</span>is synchronising on the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">cash</span></span>, holding onto it (or again, more specifically, it's monitor) until the end of the synchronised block then within that block, it requires <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">nibbles</span></span>. We can start to see the potential for deadlock.<br /><br /><pre class="java:nogutter:nocontrols" name="code">public class Kidnapper extends Thread {
<br />   public void run() {
<br />      synchronized (nibbles) {
<br />         synchronized (cash) {
<br />            take(cash);
<br />         }
<br />      }
<br />   }
<br />}
<br />
<br />public class Negotiator extends Thread {
<br />   public void run() {
<br />      synchronized (cash) {
<br />         synchronized (nibbles) {
<br />            take(nibbles);
<br />         }
<br />      }
<br />   }
<br />}
<br /></pre><br />The deadlock detector displays this woeful situation as follows.<br /><br /><pre>Deadlock detected
<br />=================
<br />
<br />"Negotiator-Thread-1":
<br />  waiting to lock Monitor of com.google.code.tempusfugit.concurrency.DeadlockDetectorTest$Cat@ce4a8a
<br />  which is held by "Kidnapper-Thread-0"
<br />
<br />"Kidnapper-Thread-0":
<br />  waiting to lock Monitor of com.google.code.tempusfugit.concurrency.DeadlockDetectorTest$Cash@7fc8b2
<br />  which is held by "Negotiator-Thread-1"
<br /></pre><br />If you fire up the example and point jconsole at it, you'll get similar results from the Thread tab. You can see how tempus-fugit tests the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">DeadlockDetector</span></span> class <a href="http://tempus-fugit.googlecode.com/svn/site/documentation/xref-test/com/google/code/tempusfugit/concurrency/DeadlockDetectorTest.html">here</a> and to find out more about see the project <a href="http://tempus-fugit.googlecode.com/svn/site/documentation/concurrency.html#Deadlock_Detection">documentation</a>.<br /><br />oh and don't worry, Nibbles was released and the <span class="Apple-style-span" style="font-family: 'Courier New',Courier,monospace;"><span class="Apple-style-span" style="font-size: small;">Kidnapper </span></span>arrested in the end.<br /><br /><div><img alt="" border="0" id="BLOGGER_PHOTO_ID_5283328307719135378" src="http://4.bp.blogspot.com/_-uMxV_fCbC4/SVInGoVdYJI/AAAAAAAAC08/I4RV1KzCyPo/s320/gibble_22x22.png" style="cursor: pointer; float: left; height: 22px; margin: 0pt 10px 10px 0pt; width: 22px;" /></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/20485368-5605379093481668727?l=pequenoperro.blogspot.com' alt='' /></div>
